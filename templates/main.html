<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YOD ‚Ä¢ Main Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-top:#b86afd; --bg-bottom:#0b0920;
    --panel:#0f0d22; --panel-2:#120f27; --ring:#2c2a45;
    --text:#EAF4FF; --muted:#9aa4b2; --accent:#00F0FF; --accent-2:#B06CFF;

    --kpi-col:160px;
    --kpi-gap:18px;

    --icon-card-h:130px; --icon-bubble:85px; --icon-size:70px;

    --bad:#8B0000;
    --bad-ink:#B30000;
    --bad-bg:rgba(139,0,0,.18);
    --bad-ring:rgba(139,0,0,.55);

    /* sizing knobs */
    --cell-height: 112px;     /* overall row cell height */
    --val-size:   32px;       /* number font size (all columns) */
    --pill-gap:   14px;       /* gap between YWT/HSL pills */
  }

  *{ box-sizing:border-box } html,body{ height:100% }
  body{
    margin:0; color:var(--text);
    font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }
  body::before{
    content:""; position:fixed; inset:0; z-index:-1;
    background:
      radial-gradient(1400px 700px at 12% -5%, rgba(58,10,104,0.85) 0%, rgba(58,10,104,0.55) 35%, rgba(58,10,104,0.20) 65%, rgba(58,10,104,0.00) 85%),
      radial-gradient(1200px 650px at 90% 0%, rgba(0,240,255,0.28) 0%, rgba(0,240,255,0.16) 35%, rgba(0,240,255,0.06) 70%, rgba(0,240,255,0.00) 90%),
      linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bottom) 100%);
    background-repeat:no-repeat;
  }

  .wrap{ max-width:none; margin:0; padding:18px 24px }

  .top{ display:flex; align-items:center; justify-content:center; margin-bottom:22px; gap:16px }
  .tabs{
    display:flex; background:rgba(255,255,255,.06); backdrop-filter:blur(6px);
    border:1px solid var(--ring); border-radius:14px; overflow:hidden;
  }
  .tab{ padding:12px 26px; text-decoration:none; color:var(--text); font-weight:800; letter-spacing:.3px; border-right:1px solid var(--ring); transition:all .2s }
  .tab:last-child{ border-right:none }
  .tab:hover{ background:rgba(255,255,255,.06) }
  .tab.active{ background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#0c0c16 }

  .layout{ display:grid; grid-template-columns:340px minmax(0, 1fr); gap:26px; align-items:start; }

  .panel-left{ display:flex; flex-direction:column; gap:18px; }
  .neo-outline{
    position:relative; border-radius:14px; padding:16px; border:3px solid transparent;
    background:linear-gradient(#0f0d22,#0f0d22) padding-box, linear-gradient(135deg,#8a2be2,#00eaff) border-box;
  }
  .logo-block{ padding:20px; display:flex; align-items:center; justify-content:center; min-height:260px; }
  .logo-img{ max-width:90%; height:auto; display:block; }

  .month-block{ padding:18px; }
  .neo-btn{
    height:56px; border-radius:10px; display:flex; align-items:center; justify-content:center;
    font-weight:800; letter-spacing:1.2px; color:#dff9ff; border:2px solid transparent;
    background:linear-gradient(#0f0d22,#0f0d22) padding-box, linear-gradient(135deg,#00eaff,#9a56ff) border-box;
    position:relative;
  }
  .neo-btn details.multi-dd{ position:absolute; inset:0; display:block; }
  .neo-btn details.multi-dd summary{
    list-style:none; cursor:pointer; user-select:none;
    width:100%; height:100%; border-radius:10px; border:0; outline:0;
    display:flex; align-items:center; justify-content:center;
    background:transparent; color:#dff9ff; font-weight:800;
  }
  .neo-btn details[open] summary{ outline:2px solid var(--accent); border-radius:10px; }
  .multi-dd .menu{
    position:absolute; top:calc(100% + 10px); left:0;
    background: var(--panel); border:1px solid var(--ring);
    border-radius:14px; padding:10px; min-width:240px; max-height:260px; overflow:auto; z-index:9999;
  }
  .multi-dd label{ display:flex; align-items:center; gap:10px; padding:8px; border-radius:10px; font-weight:700; }
  .multi-dd label:hover{ background:rgba(255,255,255,.05) }

  .term-filter{ display:flex; gap:10px; margin-top:12px; }
  .pill{
    flex:0 0 auto; padding:10px 14px; border-radius:12px; font-weight:800; letter-spacing:.3px;
    background:linear-gradient(180deg, rgba(2,7,18,.60), rgba(2,7,18,.32));
    border:1px solid var(--ring); color:#fff; cursor:pointer;
  }
  .pill.active{
    outline:2px solid var(--accent);
    box-shadow:0 0 18px rgba(0,240,255,.25);
  }

  .criteria-block{ padding:18px; }
  .criteria-title{ margin:0 0 14px 0; font-weight:900; letter-spacing:2px; text-transform:uppercase; color:#b9c3d0; padding-bottom:8px; border-bottom:3px solid #8a2be2; }
  .criteria{ background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid var(--ring); border-radius:16px; padding:16px; }
  .crit-section{ margin:0 0 14px 0; }
  .crit-head{ color:var(--accent); font-weight:900; letter-spacing:.6px; margin:6px 0 8px; }
  .crit-item{ color:#dbe7ff; font-weight:700; line-height:1.25; margin:6px 0 0 0; }
  .crit-pts{ color:#e9f6ff; font-weight:900; text-decoration:underline; text-underline-offset:4px; text-decoration-thickness:3px; margin-right:6px; }

  /* RIGHT SIDE */
  .right{ display:grid; grid-auto-rows:auto; gap:14px; min-width:0; }

  /* header: 6 metric columns on the right side */
  .header{
    display:grid;
    grid-template-columns: 1fr calc(160px*6 + 18px*5) 150px;
    gap:18px;
    align-items:start;
  }

  /* icons: tiles along the top */
  .icons{
    display:grid;
    grid-template-columns:repeat(6, 160px);
    gap:18px;
  }

  .icon-card{
    background:var(--panel); border:1px solid var(--ring); border-radius:18px;
    padding:12px 14px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px;
    color:#fff; height:130px; transition:box-shadow .2s, transform .2s, outline .2s;
  }
  .icon-card.ops{          /* image on top */
    grid-column:3 / span 2;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:8px;
  }
  .icon-card.ops .right-labels{ display:none; }

  /* ACTIVE SORT STATE ‚Äî blue highlight */
  .icon-card.active{
    outline: 2px solid var(--accent);
    box-shadow:
      0 0 0 6px rgba(0,240,255,.15),
      0 8px 22px rgba(0,0,0,.45);
    transform: translateY(-1px);
  }
  .icon-card.active .icon-title{
    background: linear-gradient(135deg,var(--accent),var(--accent-2));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent !important;
  }

  .ico{ width:var(--icon-bubble); height:var(--icon-bubble); display:grid; place-items:center; }
  .icon-img{ width:var(--icon-size); height:var(--icon-size); object-fit:contain; display:block; }
  .icon-title{
    font-weight:800;
    letter-spacing:.6px;
    font-size:14px;
    text-transform:uppercase;
    color:#fff !important;
    text-shadow:0 1px 2px rgba(0,0,0,.35);
  }
  .mini-tag{
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.12);
    border-radius:999px;
    padding:3px 10px 2px;
    font-size:11px;
    font-weight:700;
    text-transform:uppercase;
  }

  .searchline{ display:grid; grid-template-columns: 1fr; gap:12px; align-items:center; }
  .searchline .box{ display:flex; align-items:center; gap:14px; background:var(--panel); border:1px solid var(--ring); border-radius:16px; padding:14px 16px; }
  #searchBox{ flex:1; background:transparent; border:0; outline:none; color:#fff; font-size:14px; }
  .searchline .count{ font-weight:800; color:#cdd6f5; opacity:.85; white-space:nowrap; }

  .rows{ display:flex; flex-direction:column; gap:14px }

  /* rows: 6 columns area on the right */
  .row{
    display:grid;
    grid-template-columns: 1fr calc(160px*6 + 18px*5) 150px;
    gap:18px;
    align-items:stretch
  }

  .person{ display:flex; gap:14px; align-items:center; background:var(--panel); border:1px solid var(--ring); border-radius:16px; padding:16px; }
  .avatar{ width:74px; height:74px; border-radius:50%; background:#131128; display:grid; place-items:center; overflow:hidden; }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .who{ display:flex; flex-direction:column }
  .name{ font-weight:800; font-size:18px; letter-spacing:.3px }
  .name .grp{ font-weight:700; opacity:.75; margin-left:6px; }
  .role{ opacity:.85 }

  .grid{
    display:grid;
    grid-template-columns:repeat(6, 160px); /* safety, contribution, excellence, ops(2), reliability */
    gap:18px;
  }

  /* ======== CELLS (unified dark panel + centered content) ======== */
  .cell{
    position:relative;
    background:var(--panel);
    border:1px solid var(--ring);
    border-radius:16px;
    min-height: var(--cell-height);
    padding:12px;

    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    gap:8px;
    overflow:hidden;
  }
  .cell > *{ position:relative; z-index:1; }
  .cell::after{
    content:"";
    position:absolute;
    inset:6px;                      /* larger inner chip */
    border-radius:14px;
    background:var(--chip-bg, rgba(255,255,255,.04));
    border:1px solid var(--chip-ring, rgba(255,255,255,.08));
  }
  /* unify number size across all columns */
  .cell .val,
  .cell .num{ 
    font-size: var(--val-size);
    line-height: 1;
    font-weight:800;
  }

  /* inner chip colors by state */
  .cell.safety.pts-green,
  .cell.positive.pts-green,
  .cell.excellence.pts-green,
  .cell.reliability.pts-green{
    --chip-bg: rgba(0,255,160,.14);
    --chip-ring: rgba(0,255,160,.45);
    color:#00ff9e;
  }
  .cell.positive.pts-orange,
  .cell.excellence.pts-orange,
  .cell.reliability.pts-orange{
    --chip-bg: rgba(255,160,0,.14);
    --chip-ring: rgba(255,160,0,.45);
    color:#ffb24a;
  }
  .cell.safety.pts-red,
  .cell.positive.pts-red,
  .cell.excellence.pts-red,
  .cell.reliability.pts-red{
    --chip-bg: var(--bad-bg);
    --chip-ring: var(--bad-ring);
    color: var(--bad-ink);
  }

  /* ======== OPERATIONS (two equal-height pills inside the cell) ======== */
  .cell.operations{
    grid-column:span 2;
    display:grid;
    grid-template-columns:repeat(2, 1fr);
    gap:var(--pill-gap);
    align-items:stretch;
  }
  .cell.operations::after{ display:none; } /* no chip around the whole container */

  .ops-pill{
    background:rgba(3,5,10,.35);
    border:1px solid rgba(255,255,255,.06);
    border-radius:14px;
    padding:14px 10px 10px;

    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    gap:8px;

    width:100%;
    height:100%;             /* stretch to match sibling */
    min-height:auto;
  }
  /* Operations values same size as others */
  .ops-pill .num{ font-size:var(--val-size); line-height:1; font-weight:800; }

  .ops-pill .pts-badge{
    font-size:10px;
    padding:3px 7px;
    border-radius:999px;
    border:1px solid currentColor;
    background:rgba(255,255,255,.03);
  }
  .ops-pill.ywt.pts-green{ background:rgba(0,255,160,.12); border-color:rgba(0,255,160,.4); color:#00ff9e; }
  .ops-pill.ywt.pts-orange{ background:rgba(255,160,0,.12); border-color:rgba(255,160,0,.4); color:#ffb24a; }
  .ops-pill.ywt.pts-red{ background:var(--bad-bg); border-color:var(--bad-ring); color:var(--bad-ink); }
  .ops-pill.hsl.pts-green{ background:rgba(0,255,160,.12); border-color:rgba(0,255,160,.4); color:#00ff9e; }
  .ops-pill.hsl.pts-orange{ background:rgba(255,160,0,.12); border-color:rgba(255,160,0,.4); color:#ffb24a; }
  .ops-pill.hsl.pts-red{ background:var(--bad-bg); border-color:var(--bad-ring); color:var(--bad-ink); }

  /* shared badge */
  .cell .pts-badge{
    margin-top:6px; padding:3px 8px; display:inline-block;
    font-size:20px; font-weight:800; letter-spacing:.6px; text-transform:uppercase;
    border-radius:999px; border:1px solid currentColor; background:rgba(255,255,255,.03);
  }

  .points{ background:var(--panel); border:1px solid var(--ring); border-radius:16px; display:grid; place-items:center; padding:10px 0; }
  .points .num{ font-size:40px }
  .points small{ opacity:.8 }

  @media (max-width:1100px){
    .layout{ grid-template-columns:1fr }
    .header{ grid-template-columns:1fr }
    .icons{ grid-template-columns:1fr }
    .row{ grid-template-columns:1fr }
  }

  html { zoom: .75; }
</style>

</head>
<body>
  <div class="wrap">
    <!-- TOP NAV -->
    <div class="top">
      <nav class="tabs" role="tablist">
        <a class="tab active" href="#">OVERVIEW</a>
        <a class="tab" href="{{ url_for('nonshift.index', only='P123') }}">P123</a>
        <a class="tab" href="{{ url_for('nonshift.index', only='P456') }}">P456</a>
        <a class="tab" href="{{ url_for('home.role_selection') }}">HOME</a>
      </nav>
    </div>

    <div class="layout">
      <!-- LEFT -->
      <aside class="panel-left">
        <div class="logo-block neo-outline">
          <img class="logo-img" src="{{ url_for('static', filename='Neon Logo.png') }}" alt="YOD logo" onerror="this.style.display='none';">
        </div>

        <!-- Month filter -->
        <div class="neo-outline month-block">
          <div class="neo-btn">
            <details class="multi-dd" id="monthDropdown">
              <summary>
                Month: <span id="monthSummary">
                  {% if selected_months and selected_months|length > 0 %}
                    {{ selected_months|length }} selected
                  {% else %}All{% endif %}
                </span>
              </summary>
              <div class="menu">
                <label><input type="checkbox" id="allMonthsBox"> Select all</label>
                {% for m in months %}
                  <label>
                    <input type="checkbox" name="month" value="{{ m }}"
                           {% if selected_months and m in selected_months %}checked{% endif %}>
                    {{ m }}
                  </label>
                {% endfor %}
              </div>
            </details>
            <form id="filtersForm" method="GET"></form>
          </div>

          <!-- Terminal filter buttons -->
          <div class="term-filter" role="tablist" aria-label="Terminal filter">
            <button type="button"
                    class="pill {{ 'active' if (selected_terminal or 'ALL') == 'ALL' else '' }}"
                    data-terminal="ALL">All</button>
            <button type="button"
                    class="pill {{ 'active' if (selected_terminal or 'ALL') == 'P123' else '' }}"
                    data-terminal="P123">P123</button>
            <button type="button"
                    class="pill {{ 'active' if (selected_terminal or 'ALL') == 'P456' else '' }}"
                    data-terminal="P456">P456</button>
          </div>
        </div>

        <!-- Criteria -->
        <div class="neo-outline criteria-block">
          <h3 class="criteria-title">CRITERIA</h3>
          <div class="criteria">
            <div class="crit-section">
              <div class="crit-head">For All Category :</div>
              <div class="crit-item"><span class="crit-pts">5pts</span>- Top 10%</div>
              <div class="crit-item"><span class="crit-pts">4pt</span>- Next 30%</div>
              <div class="crit-item"><span class="crit-pts">3pt</span>- Next 30%</div>
              <div class="crit-item"><span class="crit-pts">2pt</span>- Next 20%</div>
              <div class="crit-item"><span class="crit-pts">1pt</span>- Bottom 10%</div>
            </div>
            <div class="crit-section">
              <div class="crit-head">Weightage :</div>
              <div class="crit-item"><span class="crit-pts">Safety</span>- 20%</div>
              <div class="crit-item"><span class="crit-pts">Contribution</span>- 10%</div>
              <div class="crit-item"><span class="crit-pts">Operations</span>- 50%</div>
              <div class="crit-item"><span class="crit-pts">Reliability</span>- 10%</div>
              <div class="crit-item"><span class="crit-pts">Excellence</span>- 10%</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- RIGHT -->
      <div class="right">
        <!-- Icon header -->
        <div class="header">
          <div></div>
          <div class="icons" aria-label="Key metric icons">
            <button class="icon-card sort-btn" type="button" data-key="safety" title="Sort by Safety" aria-pressed="false">
              <div class="ico"><img class="icon-img" src="{{ url_for('static', filename='Safety.png') }}" alt="Safety"></div>
              <div class="icon-title">SAFETY</div>
            </button>
            <button class="icon-card sort-btn" type="button" data-key="pc" title="Sort by Positive Contribution" aria-pressed="false">
              <div class="ico"><img class="icon-img" src="{{ url_for('static', filename='Positive.jpeg') }}" alt="Positive Contribution"></div>
              <div class="icon-title">CONTRIBUTION</div>
            </button>
            <button class="icon-card ops sort-btn" type="button" data-key="ops" title="Sort by Operations" aria-pressed="false">
              <div class="ico">
                <img class="icon-img" src="{{ url_for('static', filename='Operations.png') }}" alt="Operations">
              </div>
              <div class="icon-title">OPERATIONS (YWT ‚Ä¢ HSL)</div>
            </button>
            <button class="icon-card sort-btn" type="button" data-key="reliability" title="Sort by Reliability" aria-pressed="false">
              <div class="ico"><img class="icon-img" src="{{ url_for('static', filename='Reliability.png') }}" alt="Reliability"></div>
              <div class="icon-title">RELIABILITY</div>
            </button>
            <button class="icon-card sort-btn" type="button" data-key="excellence" title="Sort by Excellence" aria-pressed="false">
              <div class="ico"><img class="icon-img" src="{{ url_for('static', filename='Excellence.png') }}" alt="Excellence"></div>
              <div class="icon-title">EXCELLENCE</div>
            </button>
          </div>
          <div></div>
        </div>

        <!-- Search -->
        <div class="searchline">
          <div class="box">
            <input id="searchBox" type="text" placeholder="Search name or role‚Ä¶" aria-label="Search" />
            <div class="count"><span id="empCount">{{ people|length }}</span> employees</div>
          </div>
        </div>

        <!-- Rows -->
        <section id="rows" class="rows" aria-label="Employee rows">
          {% for p in people %}
          {% set _h = p.hsl_points|default(0) %}
          {% set _h_class = p.hsl_class|default('pts-red') %}
          {% set _rel = p.reliability|default('') %}
          {% set _relpts = p.reliability_points|default(0) %}
          {% set _exc = p.excellence|default(0) %}
          {% set _excpts = p.excellence_points|default(0) %}
          <article class="row"
                   data-name="{{ p.name|lower }}"
                   data-role="{{ (p.designation or '')|lower }}"
                   data-safetypts="{{ p.safety_points }}"
                   data-si="{{ p.si_done }}"
                   data-shifts="{{ p.shift_count }}"
                   data-pcpts="{{ p.pc_points|default(0) }}"
                   data-pccount="{{ p.pc_count|default(0) }}"
                   data-ywt="{{ (p.ywt if p.ywt != '-' else '') }}"
                   data-hsl="{{ (p.hsl[:-1] if p.hsl and '%' in p.hsl else p.hsl) }}"
                   data-rel="{{ _rel }}"
                   data-relpts="{{ _relpts }}"
                   data-exc="{{ _exc }}"
                   data-excpts="{{ _excpts }}">
            <div class="person">
              <div class="avatar">
                {% if p.photo %}<img src="{{ p.photo }}" alt="">{% else %}<span>üßë‚Äçüíº</span>{% endif %}
              </div>
              <div class="who">
                <div class="name">
                  {{ p.name }}{% if p.group %} <span class="grp">({{ p.group }})</span>{% endif %}
                </div>
                <div class="role">{{ p.designation }}</div>
              </div>
            </div>

            <div class="grid">
              <!-- 1. SAFETY -->
              <div class="cell safety {{ p.safety_class }}">
                <div class="num">{{ p.si_done }}/{{ p.shift_count }}</div>
                <div class="pts-badge">{{ p.safety_points }} pts</div>
              </div>
              <!-- 2. CONTRIBUTION -->
              <div class="cell positive {{ p.pc_class|default('pts-red') }}">
                <div class="num">{{ p.pc_count|default(0) }}</div>
                <div class="pts-badge">{{ p.pc_points|default(0) }} pts</div>
              </div>
              <!-- 3. OPERATIONS -->
              <div class="cell operations">
                <div class="ops-pill ywt {{ p.ywt_class }}">
                  <div class="num">{{ p.ywt }}</div>
                  <div class="pts-badge">{{ p.ywt_points }} pts</div>
                </div>
                <div class="ops-pill hsl {{ _h_class }}">
                  <div class="num">{{ p.hsl }}</div>
                  <div class="pts-badge">{{ _h }} pts</div>
                </div>
              </div>
              <!-- 4. RELIABILITY -->
              <div class="cell positive {{ p.reliability_class|default('pts-red') }}">
                <div class="num">
                  {% if p.reliability is number %}
                    {{ "%.1f"|format(p.reliability) }}%
                  {% else %}
                    {{ p.reliability }}
                  {% endif %}
                </div>
                <div class="pts-badge">{{ p.reliability_points|default(0) }} pts</div>
              </div>
              <!-- 5. EXCELLENCE -->
              <div class="cell positive {{ p.excellence_class|default('pts-red') }}">
                <div class="num">{{ p.excellence|default(0) }}</div>
                <div class="pts-badge">{{ p.excellence_points|default(0) }} pts</div>
              </div>
            </div>

            <div class="points">
              <div class="num">{{ '%.2f' % p.points }}</div>
              <small>POINTS</small>
            </div>
          </article>
          {% endfor %}

          {% if not people or people|length == 0 %}
          <article class="row">
            <div class="person"><div class="who"><div class="name">No employees found</div></div></div>
            <div class="grid">
              <div class="cell"><div class="num">-</div></div>
              <div class="cell"><div class="num">-</div></div>
              <div class="cell operations">
                <div class="ops-pill"><div class="num">-</div></div>
                <div class="ops-pill"><div class="num">-</div></div>
              </div>
              <div class="cell"><div class="num">-</div></div>
              <div class="cell"><div class="num">-</div></div>
            </div>
            <div class="points"><div class="num">-</div><small>POINTS</small></div>
          </article>
          {% endif %}
        </section>
      </div>
    </div>
  </div>

  <!-- Search -->
  <script>
    (function () {
      const box = document.getElementById('searchBox');
      const countEl = document.getElementById('empCount');
      const rows = Array.from(document.querySelectorAll('.rows .row'));
      if (!box) return;
      const norm = s => (s||'').toLowerCase().trim();
      function render(){
        const q = norm(box.value);
        let shown = 0;
        rows.forEach(r=>{
          const name = r.dataset.name || '';
          const role = r.dataset.role || '';
          const hit = (!q || name.includes(q) || role.includes(q));
          r.style.display = hit ? '' : 'none';
          if (hit) shown++;
        });
        if (countEl) countEl.textContent = shown;
      }
      box.addEventListener('input', render);
    })();
  </script>

  <!-- Month filter behaviour -->
  <script>
  (function(){
    const dd   = document.getElementById('monthDropdown');
    const all  = document.getElementById('allMonthsBox');
    if (!dd || !all) return;

    const boxes= Array.from(dd.querySelectorAll('input[name="month"]'));
    const sum  = document.getElementById('monthSummary');

    function updateSummary(){
      const n = boxes.filter(b=>b.checked).length;
      sum.textContent = n === 0 ? 'All' : `${n} selected`;
    }
    function autoSubmit(){
      const params = new URLSearchParams(window.location.search);
      params.set('terminal', "{{ (selected_terminal or 'ALL') }}");
      params.delete('month');
      boxes.filter(b=>b.checked).forEach(b=>params.append('month', b.value));
      window.location.assign(`${window.location.pathname}?${params.toString()}`);
    }

    all.addEventListener('change', () => {
      boxes.forEach(b => b.checked = all.checked);
      updateSummary(); autoSubmit();
    });
    boxes.forEach(b => b.addEventListener('change', () => {
      if (!b.checked) all.checked = false;
      else if (boxes.every(x=>x.checked)) all.checked = true;
      updateSummary(); autoSubmit();
    }));

    all.checked = boxes.length > 0 && boxes.every(b => b.checked);
    updateSummary();
    document.addEventListener('click', (e)=>{ if (!dd.contains(e.target)) dd.removeAttribute('open'); });
  })();
  </script>

  <!-- Terminal filter behaviour -->
  <script>
  (function(){
    const wrap = document.querySelector('.term-filter');
    if (!wrap) return;

    wrap.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-terminal]');
      if (!btn) return;
      const t = btn.dataset.terminal;
      const params = new URLSearchParams(window.location.search);
      params.set('terminal', t);
      const url = `${window.location.pathname}?${params.toString()}`;
      window.location.assign(url);
    });
  })();
  </script>

  <!-- Click-to-sort -->
  <script>
  (function(){
    const container = document.getElementById('rows');
    const buttons = Array.from(document.querySelectorAll('.sort-btn'));
    if (!container || !buttons.length) return;

    const original = Array.from(container.querySelectorAll('.row'));
    let activeKey = null;

    function ratio(el){
      const si = Number(el.dataset.si || '0');
      const sh = Number(el.dataset.shifts || '0');
      return (sh > 0) ? (si / sh) : -1;
    }

    function sortSafety(){
      const rows = Array.from(container.querySelectorAll('.row'));
      rows.sort((a,b)=>{
        const ap = Number(a.dataset.safetypts || '0');
        const bp = Number(b.dataset.safetypts || '0');
        if (ap !== bp) return bp - ap;
        const ar = ratio(a), br = ratio(b);
        if (ar !== br) return br - ar;
        return (a.dataset.name || '').localeCompare(b.dataset.name || '');
      });
      return rows;
    }

    function sortPC(){
      const rows = Array.from(container.querySelectorAll('.row'));
      rows.sort((a,b)=>{
        const ap = Number(a.dataset.pcpts || '0');
        const bp = Number(b.dataset.pcpts || '0');
        if (ap !== bp) return bp - ap;
        const ac = Number(a.dataset.pccount || '0');
        const bc = Number(b.dataset.pccount || '0');
        if (ac !== bc) return bc - ac;
        return (a.dataset.name || '').localeCompare(b.dataset.name || '');
      });
      return rows;
    }

    function sortOps(){
      const rows = Array.from(container.querySelectorAll('.row'));
      rows.sort((a,b)=>{
        const ay = Number(a.dataset.ywt || '999');
        const by = Number(b.dataset.ywt || '999');
        if (!isNaN(ay) && !isNaN(by) && ay !== by) return ay - by;
        const ah = Number(a.dataset.hsl || '0');
        const bh = Number(b.dataset.hsl || '0');
        if (!isNaN(ah) && !isNaN(bh) && ah !== bh) return bh - ah;
        return (a.dataset.name || '').localeCompare(b.dataset.name || '');
      });
      return rows;
    }

    function sortReliability(){
      const rows = Array.from(container.querySelectorAll('.row'));
      rows.sort((a,b)=>{
        const ar = Number(a.dataset.rel || '0');
        const br = Number(b.dataset.rel || '0');
        if (ar !== br) return br - ar;
        const ap = Number(a.dataset.relpts || '0');
        const bp = Number(b.dataset.relpts || '0');
        if (ap !== bp) return bp - ap;
        return (a.dataset.name || '').localeCompare(b.dataset.name || '');
      });
      return rows;
    }

    function sortExcellence(){
      const rows = Array.from(container.querySelectorAll('.row'));
      rows.sort((a,b)=>{
        const ae = Number(a.dataset.exc || '0');
        const be = Number(b.dataset.exc || '0');
        if (ae !== be) return be - ae;
        const ap = Number(a.dataset.excpts || '0');
        const bp = Number(b.dataset.excpts || '0');
        if (ap !== bp) return bp - ap;
        return (a.dataset.name || '').localeCompare(b.dataset.name || '');
      });
      return rows;
    }

    function render(list){
      const frag = document.createDocumentFragment();
      list.forEach(r => frag.appendChild(r));
      container.innerHTML = '';
      container.appendChild(frag);
    }

    buttons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = btn.dataset.key;
        if (activeKey === key){
          // turn off sorting and remove active highlight
          activeKey = null;
          buttons.forEach(b=>{
            b.classList.remove('active');
            b.setAttribute('aria-pressed','false');
          });
          render(original.slice());
        } else {
          // activate selected sort and highlight button
          activeKey = key;
          buttons.forEach(b=>{
            const on = (b===btn);
            b.classList.toggle('active', on);
            b.setAttribute('aria-pressed', on ? 'true' : 'false');
          });
          if (key === 'safety') render(sortSafety());
          else if (key === 'pc') render(sortPC());
          else if (key === 'ops') render(sortOps());
          else if (key === 'reliability') render(sortReliability());
          else if (key === 'excellence') render(sortExcellence());
        }
      });
    });
  })();
  </script>
</body>
</html>
