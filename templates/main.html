<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YOD • Main Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-top:#b86afd; --bg-bottom:#0b0920;
    --panel:#0f0d22; --panel-2:#120f27; --ring:#2c2a45;
    --text:#EAF4FF; --muted:#9aa4b2; --accent:#00F0FF; --accent-2:#B06CFF;

    --kpi-col:160px; --kpi-gap:22px; --kpi-wrap:calc(var(--kpi-col)*4 + var(--kpi-gap)*3);
    --icon-card-h:130px; --icon-bubble:85px; --icon-size:70px;
  }

  *{ box-sizing:border-box } html,body{ height:100% }
  body{
    margin:0; color:var(--text);
    font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:none; position:relative;
  }
  body::before{
    content:""; position:fixed; inset:0; z-index:-1;
    background:
      radial-gradient(1400px 700px at 12% -5%, rgba(58,10,104,0.85) 0%, rgba(58,10,104,0.55) 35%, rgba(58,10,104,0.20) 65%, rgba(58,10,104,0.00) 85%),
      radial-gradient(1200px 650px at 90% 0%, rgba(0,240,255,0.28) 0%, rgba(0,240,255,0.16) 35%, rgba(0,240,255,0.06) 70%, rgba(0,240,255,0.00) 90%),
      linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bottom) 100%);
    background-repeat:no-repeat;
  }

  .wrap{ max-width:none; margin:0; padding:18px 24px }

  .top{ display:flex; align-items:center; justify-content:center; margin-bottom:22px; gap:16px }
  .tabs{
    display:flex; background:rgba(255,255,255,.06); backdrop-filter:blur(6px);
    border:1px solid var(--ring); border-radius:14px; overflow:hidden;
  }
  .tab{ padding:12px 26px; text-decoration:none; color:var(--text); font-weight:800; letter-spacing:.3px; border-right:1px solid var(--ring); transition:all .2s }
  .tab:last-child{ border-right:none }
  .tab:hover{ background:rgba(255,255,255,.06) }
  .tab.active{ background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#0c0c16 }

  .layout{ display:grid; grid-template-columns:340px minmax(0, 1fr); gap:26px; align-items:start; }

  .panel-left{ display:flex; flex-direction:column; gap:18px; position:relative; z-index:10; }
  .neo-outline{
    position:relative; border-radius:14px; padding:16px; border:3px solid transparent;
    background:linear-gradient(#0f0d22,#0f0d22) padding-box, linear-gradient(135deg,#8a2be2,#00eaff) border-box;
  }
  .logo-block{ padding:20px; display:flex; align-items:center; justify-content:center; min-height:260px; }
  .logo-img{ max-width:90%; height:auto; display:block; }

  .month-block{ padding:18px; position:relative; z-index:30; }
  .neo-btn{
    height:56px; border-radius:10px; display:flex; align-items:center; justify-content:center;
    font-weight:800; letter-spacing:1.2px; color:#dff9ff; border:2px solid transparent;
    background:linear-gradient(#0f0d22,#0f0d22) padding-box, linear-gradient(135deg,#00eaff,#9a56ff) border-box;
    position:relative; z-index:40;
  }
  .neo-btn details.multi-dd{ position:absolute; inset:0; display:block; z-index:50; }
  .neo-btn details.multi-dd summary{
    list-style:none; cursor:pointer; user-select:none;
    width:100%; height:100%; border-radius:10px; border:0; outline:0;
    display:flex; align-items:center; justify-content:center;
    background:transparent; color:#dff9ff; font-weight:800;
  }
  .neo-btn details[open] summary{ outline:2px solid var(--accent); border-radius:10px; }
  .multi-dd .menu{
    position:absolute; top:calc(100% + 10px); left:0;
    background: var(--panel); border:1px solid var(--ring);
    border-radius:14px; padding:10px; min-width:240px; max-height:260px; overflow:auto; z-index:9999;
  }
  .multi-dd label{ display:flex; align-items:center; gap:10px; padding:8px; border-radius:10px; font-weight:700; }
  .multi-dd label:hover{ background:rgba(255,255,255,.05) }
  .multi-dd input[type="checkbox"]{ width:16px; height:16px }

  /* Terminal button group */
  .term-filter{ display:flex; gap:10px; margin-top:12px; }
  .pill{
    flex:0 0 auto; padding:10px 14px; border-radius:12px; font-weight:800; letter-spacing:.3px;
    background:linear-gradient(180deg, rgba(2,7,18,.60), rgba(2,7,18,.32));
    border:1px solid var(--ring); color:#fff; cursor:pointer;
  }
  .pill.active{
    outline:2px solid var(--accent);
    box-shadow:0 0 18px rgba(0,240,255,.25);
  }

  .criteria-block{ padding:18px; position:relative; z-index:0; }
  .criteria-title{ margin:0 0 14px 0; font-weight:900; letter-spacing:2px; text-transform:uppercase; color:#b9c3d0; padding-bottom:8px; border-bottom:3px solid #8a2be2; }
  .criteria{ background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid var(--ring); border-radius:16px; padding:16px; }
  .crit-section{ margin:0 0 14px 0; }
  .crit-section:not(:last-child){ padding-bottom:10px; border-bottom:2px solid rgba(255,255,255,.04); }
  .crit-head{ color:var(--accent); font-weight:900; letter-spacing:.6px; margin:6px 0 8px; }
  .crit-item{ color:#dbe7ff; font-weight:700; line-height:1.25; margin:6px 0 0 0; }
  .crit-pts{ color:#e9f6ff; font-weight:900; text-decoration:underline; text-underline-offset:4px; text-decoration-thickness:3px; margin-right:6px; }

  .right{ display:grid; grid-auto-rows:auto; gap:14px; min-width:0; }
  .header{ display:grid; grid-template-columns: 1fr var(--kpi-wrap) 110px; gap:18px; align-items:start; }
  .kpi-grid{ display:grid; grid-template-columns:repeat(4, var(--kpi-col)); gap:var(--kpi-gap) }
  .icons{ grid-column:2; justify-self:start; width:var(--kpi-wrap) }

  /* make icons act like buttons + show active state */
  .icon-card{ width:var(--kpi-col); height:var(--icon-card-h); background:var(--panel); border:1px solid var(--ring); border-radius:18px; padding:12px 14px; display:grid; place-items:center; gap:8px; }
  .sort-btn{ cursor:pointer; }
  .sort-btn.active{ outline:2px solid var(--accent); box-shadow:0 0 16px rgba(0,240,255,.35) inset, 0 0 16px rgba(0,240,255,.25) }

  .ico{ width:var(--icon-bubble); height:var(--icon-bubble); border-radius:50%; display:grid; place-items:center; }
  .icon-img{ width:var(--icon-size); height:var(--icon-size); object-fit:contain; display:block; }

  .searchline{ display:grid; grid-template-columns: 1fr var(--kpi-wrap) 110px; gap:18px; align-items:center; }
  .searchline .box{ grid-column:1 / 4; display:flex; align-items:center; gap:14px; background:var(--panel); border:1px solid var(--ring); border-radius:16px; padding:14px 16px; }
  #searchBox{ flex:1; background:transparent; border:0; outline:none; color:#fff; font-size:14px; }
  .searchline .count{ font-weight:800; color:#cdd6f5; opacity:.85; white-space:nowrap; }

  .rows{ display:flex; flex-direction:column; gap:18px }
  .row{ display:grid; grid-template-columns: 1fr var(--kpi-wrap) 110px; gap:18px; align-items:stretch }
  .person{ display:flex; gap:14px; align-items:center; background:var(--panel); border:1px solid var(--ring); border-radius:16px; padding:16px; }
  .avatar{ width:74px; height:74px; border-radius:12px; background:#131128; display:grid; place-items:center; overflow:hidden; }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .who{ display:flex; flex-direction:column }
  .name{ font-weight:800; font-size:18px; letter-spacing:.3px }
  .name .grp{ font-weight:700; opacity:.75; margin-left:6px; letter-spacing:.3px; }
  .role{ opacity:.85 }

  .grid{ display:grid; grid-template-columns:repeat(4, var(--kpi-col)); gap:var(--kpi-gap); width:var(--kpi-wrap) }
  .cell{ display:grid; place-items:center; background:var(--panel); border:1px dashed rgba(255,255,255,.08); border-radius:16px; padding:22px 10px; }
  .num{ font-size:40px; font-weight:800; text-shadow:0 0 18px rgba(41,216,255,.35) }

  .points{ background:var(--panel); border:1px solid var(--ring); border-radius:16px; display:grid; place-items:center; padding:10px 0; }
  .points .num{ font-size:40px }
  .points small{ opacity:.8 }

  @media (max-width:1100px){
    .layout{ grid-template-columns:1fr }
    .header{ grid-template-columns:1fr }
    .icons{ grid-column:1; justify-self:center }
    .row{ grid-template-columns:1fr }
    .searchline{ grid-template-columns:1fr }
    .searchline .box{ grid-column:auto }
  }

  /* YWT cell colors */
  .cell.ywt{ border:1px solid var(--ring); }
  .cell.ywt .num{ text-shadow:none; }
  .cell.ywt.pts-green{ background:rgba(0,255,160,.14); border-color:rgba(0,255,160,.45); color:#00ff9e; }
  .cell.ywt.pts-orange{ background:rgba(255,160,0,.14); border-color:rgba(255,160,0,.45); color:#ffb24a; }
  .cell.ywt.pts-red{ background:rgba(255,70,70,.14); border-color:rgba(255,70,70,.45); color:#ff6b6b; }

  /* Safety cell (binary) */
  .cell.safety{ border:1px solid var(--ring); }
  .cell.safety .num{ text-shadow:none; }
  .cell.safety.pts-green{ background:rgba(0,255,160,.14); border-color:rgba(0,255,160,.45); color:#00ff9e; }
  .cell.safety.pts-red{ background:rgba(255,70,70,.14); border-color:rgba(255,70,70,.45); color:#ff6b6b; }

  /* HSL cell (3&2 = green, 1 = orange, 0 = red) */
  .cell.hsl{ border:1px solid var(--ring); }
  .cell.hsl .num{ text-shadow:none; }
  .cell.hsl.pts-green{ background:rgba(0,255,160,.14); border-color:rgba(0,255,160,.45); color:#00ff9e; }
  .cell.hsl.pts-orange{ background:rgba(255,160,0,.14); border-color:rgba(255,160,0,.45); color:#ffb24a; }
  .cell.hsl.pts-red{ background:rgba(255,70,70,.14); border-color:rgba(255,70,70,.45); color:#ff6b6b; }

  /* Small badge inside metric cells */
  .cell .pts-badge{
    margin-top:6px; padding:3px 8px; display:inline-block;
    font-size:12px; font-weight:800; letter-spacing:.6px; text-transform:uppercase;
    border-radius:999px; border:1px solid currentColor; background:rgba(255,255,255,.06); opacity:.95;
  }
  /* FISH cell (binary) */
  .cell.fish{ border:1px solid var(--ring); }
  .cell.fish .num{
    text-shadow:none;
    font-size: clamp(20px, 2.4vw, 40px);
    line-height: 1.05;
    white-space: nowrap;
  }
  .cell.fish.pts-green{ background:rgba(0,255,160,.14); border-color:rgba(0,255,160,.45); color:#00ff9e; }
  .cell.fish.pts-red{ background:rgba(255,70,70,.14); border-color:rgba(0,255,160,.45); color:#ff6b6b; }
</style>
</head>

<body>
  <div class="wrap">
    <!-- TOP NAV -->
    <div class="top">
      <nav class="tabs" role="tablist">
        <a class="tab active" href="#">OVERVIEW</a>
        <a class="tab" href="{{ url_for('nonshift.index', only='P123') }}">P123</a>
        <a class="tab" href="{{ url_for('nonshift.index', only='P456') }}">P456</a>
        <a class="tab" href="{{ url_for('home.role_selection') }}">HOME</a>
      </nav>
    </div>

    <div class="layout">
      <!-- LEFT -->
      <aside class="panel-left">
        <div class="logo-block neo-outline">
          <img class="logo-img" src="{{ url_for('static', filename='Neon Logo.png') }}" alt="YOD logo" onerror="this.style.display='none';">
        </div>

        <!-- Month filter -->
        <div class="neo-outline month-block">
          <div class="neo-btn">
            <details class="multi-dd" id="monthDropdown">
              <summary>
                Month: <span id="monthSummary">
                  {% if selected_months and selected_months|length > 0 %}
                    {{ selected_months|length }} selected
                  {% else %}All{% endif %}
                </span>
              </summary>
              <div class="menu">
                <label><input type="checkbox" id="allMonthsBox"> Select all</label>
                {% for m in months %}
                  <label>
                    <input type="checkbox" name="month" value="{{ m }}"
                           {% if selected_months and m in selected_months %}checked{% endif %}>
                    {{ m }}
                  </label>
                {% endfor %}
              </div>
            </details>
            <form id="filtersForm" method="GET"></form>
          </div>

          <!-- Terminal filter buttons -->
          <div class="term-filter" role="tablist" aria-label="Terminal filter">
            <button type="button"
                    class="pill {{ 'active' if (selected_terminal or 'ALL') == 'ALL' else '' }}"
                    data-terminal="ALL">All</button>
            <button type="button"
                    class="pill {{ 'active' if (selected_terminal or 'ALL') == 'P123' else '' }}"
                    data-terminal="P123">P123</button>
            <button type="button"
                    class="pill {{ 'active' if (selected_terminal or 'ALL') == 'P456' else '' }}"
                    data-terminal="P456">P456</button>
          </div>
        </div>

        <!-- Criteria -->
        <div class="neo-outline criteria-block">
          <h3 class="criteria-title">CRITERIA</h3>
          <div class="criteria">
            <div class="crit-section">
              <div class="crit-head">YWT :</div>
              <div class="crit-item"><span class="crit-pts">6pts</span>- For P123, below 9.5. For P456 below 7.4</div>
              <div class="crit-item"><span class="crit-pts">4pts</span>- For P123, 9.5-9.7. For P456 7.4-7.6</div>
              <div class="crit-item"><span class="crit-pts">2pts</span>- For P123, 9.7-10. For P456 7.6-7.9</div>
            </div>
            <div class="crit-section">
              <div class="crit-head">SAFETY :</div>
              <div class="crit-item"><span class="crit-pts">3pts</span>- If every shift worked has 1 SI</div>
            </div>
            <div class="crit-section">
              <div class="crit-head">HSL :</div>
              <div class="crit-item"><span class="crit-pts">3pts</span>- Average across all terminal &gt; 90%</div>
              <div class="crit-item"><span class="crit-pts">2pts</span>- Average across all terminal 85-90%</div>
              <div class="crit-item"><span class="crit-pts">1pts</span>- Average across all terminal 80-85%</div>
            </div>
            <div class="crit-section">
              <div class="crit-head">FISH :</div>
              <div class="crit-item"><span class="crit-pts">1pts</span>- if give/receive fish</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- RIGHT -->
      <div class="right">
        <!-- Icon header -->
        <div class="header">
          <div></div>
          <div class="icons kpi-grid" aria-label="Key metric icons">
            <!-- make these buttons and tag each with a sort key -->
            <button class="icon-card icon-plain sort-btn" type="button" data-key="ywt" title="Sort by YWT">
              <div class="ico"><img class="icon-img" src="{{ url_for('static', filename='YWT.jpg') }}" alt="YWT"></div>
              <div class="icon-title">YWT</div>
            </button>
            <button class="icon-card icon-plain sort-btn" type="button" data-key="safety" title="Sort by Safety">
              <div class="ico"><img class="icon-img" src="{{ url_for('static', filename='Safety.jpg') }}" alt="Safety"></div>
              <div class="icon-title">SAFETY</div>
            </button>
            <button class="icon-card icon-plain sort-btn" type="button" data-key="hsl" title="Sort by HSL">
              <div class="ico"><img class="icon-img" src="{{ url_for('static', filename='HSL.jpg') }}" alt="HSL"></div>
              <div class="icon-title">HSL</div>
            </button>
            <button class="icon-card icon-plain sort-btn" type="button" data-key="fish" title="Sort by Fish">
              <div class="ico"><img class="icon-img" src="{{ url_for('static', filename='Fish.jpg') }}" alt="Fish"></div>
              <div class="icon-title">FISH</div>
            </button>
          </div>
          <div></div>
        </div>

        <!-- Search -->
        <div class="searchline">
          <div class="box">
            <input id="searchBox" type="text" placeholder="Search name or role…" aria-label="Search" />
            <div class="count"><span id="empCount">{{ people|length }}</span> employees</div>
          </div>
        </div>

        <!-- Rows -->
        <section id="rows" class="rows" aria-label="Employee rows">
          {% for p in people %}
          <!-- add sort data-* attributes -->
          <article class="row"
                   data-name="{{ p.name|lower }}"
                   data-role="{{ (p.designation or '')|lower }}"
                   data-total="{{ p.points }}"
                   data-ywt="{{ (p.ywt if p.ywt != '-' else '') }}"
                   data-ywtpts="{{ p.ywt_points }}"
                   data-si="{{ p.si_done }}"
                   data-shifts="{{ p.shift_count }}"
                   data-safetypts="{{ p.safety_points }}"
                   data-hsl="{{ (p.hsl[:-1] if p.hsl and '%' in p.hsl else p.hsl) }}"
                   data-fish="{{ p.fish_points }}">
            <div class="person">
              <div class="avatar">
                {% if p.photo %}<img src="{{ p.photo }}" alt="">{% else %}<span>🧑‍💼</span>{% endif %}
              </div>
              <div class="who">
                <div class="name">
                  {{ p.name }}{% if p.group %} <span class="grp">({{ p.group }})</span>{% endif %}
                </div>
                <div class="role">{{ p.designation }}</div>
              </div>
            </div>

            <div class="grid">
              <!-- YWT: value + badge -->
              <div class="cell ywt {{ p.ywt_class }}">
                <div class="num">{{ p.ywt }}</div>
                <div class="pts-badge">{{ p.ywt_points }} pts</div>
              </div>

              <!-- SAFETY: SI/Shift + badge -->
              <div class="cell safety {{ p.safety_class }}">
                <div class="num">{{ p.si_done }}/{{ p.shift_count }}</div>
                <div class="pts-badge">{{ p.safety_points }} pts</div>
              </div>

              {# HSL: show average % + points, color mapping 3&2=green, 1=orange, 0=red #}
              {% set _h = p.hsl_points|default(0) %}
              {% if _h > 2 %}
                {% set _h_class = 'pts-green' %}
              {% elif _h > 1 %}
                {% set _h_class = 'pts-orange' %}
              {% else %}
                {% set _h_class = 'pts-red' %}
              {% endif %}
              <div class="cell hsl {{ _h_class }}">
                <div class="num">{{ p.hsl }}</div>
                <div class="pts-badge">{{ _h }} pts</div>
              </div>

              <!-- FISH: label above point, color-coded -->
              <div class="cell fish {{ p.fish_class }}">
                <div class="num">{{ p.fish_label }}</div>
                <div class="pts-badge">{{ p.fish_points }} pt</div>
              </div>

            </div>

            <div class="points">
              <div class="num">{{ p.points }}</div>
              <small>POINTS</small>
            </div>
          </article>
          {% endfor %}

          {% if not people or people|length == 0 %}
          <article class="row">
            <div class="person"><div class="who"><div class="name">No employees found</div></div></div>
            <div class="grid">
              <div class="cell"><div class="num">-</div></div>
              <div class="cell"><div class="num">-</div></div>
              <div class="cell"><div class="num">-</div></div>
              <div class="cell"><div class="num">-</div></div>
            </div>
            <div class="points"><div class="num">-</div><small>POINTS</small></div>
          </article>
          {% endif %}
        </section>
      </div>
    </div>
  </div>

  <!-- Search filter + live count -->
  <script>
    (function () {
      const box = document.getElementById('searchBox');
      const countEl = document.getElementById('empCount');
      const rows = Array.from(document.querySelectorAll('.rows .row'));
      if (!box) return;
      const norm = s => (s||'').toLowerCase().trim();
      const match = (row,q) => !q ||
        norm(row.querySelector('.who .name')?.textContent).includes(q) ||
        norm(row.querySelector('.who .role')?.textContent).includes(q);
      function render(){
        const q = norm(box.value);
        let shown = 0;
        rows.forEach(r=>{
          const hit = match(r, q);
          r.style.display = hit ? '' : 'none';
          if (hit) shown++;
        });
        if (countEl) countEl.textContent = shown;
      }
      box.addEventListener('input', render);
    })();
  </script>

  <!-- Month filter behaviour -->
  <script>
  (function(){
    const dd   = document.getElementById('monthDropdown');
    const all  = document.getElementById('allMonthsBox');
    if (!dd || !all) return;

    const boxes= Array.from(dd.querySelectorAll('input[name="month"]'));
    const sum  = document.getElementById('monthSummary');

    function updateSummary(){
      const n = boxes.filter(b=>b.checked).length;
      sum.textContent = n === 0 ? 'All' : `${n} selected`;
    }
    function autoSubmit(){
      const params = new URLSearchParams(window.location.search);
      // preserve terminal filter
      params.set('terminal', "{{ (selected_terminal or 'ALL') }}");
      // months
      params.delete('month');
      boxes.filter(b=>b.checked).forEach(b=>params.append('month', b.value));
      window.location.assign(`${window.location.pathname}?${params.toString()}`);
    }

    all.addEventListener('change', () => {
      boxes.forEach(b => b.checked = all.checked);
      updateSummary(); autoSubmit();
    });
    boxes.forEach(b => b.addEventListener('change', () => {
      if (!b.checked) all.checked = false;
      else if (boxes.every(x=>x.checked)) all.checked = true;
      updateSummary(); autoSubmit();
    }));

    all.checked = boxes.length > 0 && boxes.every(b => b.checked);
    updateSummary();
    document.addEventListener('click', (e)=>{ if (!dd.contains(e.target)) dd.removeAttribute('open'); });
  })();
  </script>

  <!-- Terminal filter behaviour -->
  <script>
  (function(){
    const wrap = document.querySelector('.term-filter');
    if (!wrap) return;

    wrap.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-terminal]');
      if (!btn) return;
      const t = btn.dataset.terminal; // ALL / P123 / P456
      const params = new URLSearchParams(window.location.search);
      params.set('terminal', t); // set terminal
      // keep any existing month selections intact
      const url = `${window.location.pathname}?${params.toString()}`;
      window.location.assign(url);
    });
  })();
  </script>

  <!-- Click-to-sort behaviour -->
  <script>
  (function(){
    const container = document.getElementById('rows');
    if (!container) return;

    const original = Array.from(container.querySelectorAll('.row')); // initial order
    const buttons  = Array.from(document.querySelectorAll('.sort-btn'));
    let activeKey = null;

    const getN = (el, name) => {
      const v = el.dataset[name];
      if (v === undefined || v === '') return NaN;
      const n = Number(v);
      return isNaN(n) ? NaN : n;
    };
    const byNum = (a,b) => (a>b) - (a<b);

    function reinsert(list){
      const frag = document.createDocumentFragment();
      list.forEach(x => frag.appendChild(x));
      container.innerHTML = '';
      container.appendChild(frag);
    }
    function restore(){ reinsert(original.slice()); }

    function ratio(el){
      const si = getN(el,'si'), sh = getN(el,'shifts');
      return (isNaN(si) || isNaN(sh) || sh<=0) ? -1 : (si/sh);
    }

    function sortBy(key){
      const rows = Array.from(container.querySelectorAll('.row'));
      const list = rows.slice();

      if (key === 'ywt'){                // lower YWT better
        list.sort((a,b)=>{
          const av=getN(a,'ywt'), bv=getN(b,'ywt');
          if (isNaN(av) && !isNaN(bv)) return 1;
          if (!isNaN(av) && isNaN(bv)) return -1;
          if (av !== bv) return byNum(av,bv);           // ascending
          const ap=getN(a,'ywtpts'), bp=getN(b,'ywtpts');
          if (ap !== bp) return byNum(bp,ap);
          return byNum(a.dataset.name,b.dataset.name);
        });
      } else if (key === 'safety'){      // more points, better SI ratio
        list.sort((a,b)=>{
          const ap=getN(a,'safetypts'), bp=getN(b,'safetypts');
          if (ap !== bp) return byNum(bp,ap);
          const ar=ratio(a), br=ratio(b);
          if (ar !== br) return byNum(br,ar);
          return byNum(a.dataset.name,b.dataset.name);
        });
      } else if (key === 'hsl'){         // higher pass %
        list.sort((a,b)=>{
          const av=getN(a,'hsl'), bv=getN(b,'hsl');
          if (isNaN(av) && !isNaN(bv)) return 1;
          if (!isNaN(av) && isNaN(bv)) return -1;
          if (av !== bv) return byNum(bv,av);           // descending
          return byNum(a.dataset.name,b.dataset.name);
        });
      } else if (key === 'fish'){        // Fish (1) first
        list.sort((a,b)=>{
          const av=getN(a,'fish'), bv=getN(b,'fish');
          if (av !== bv) return byNum(bv,av);
          return byNum(a.dataset.name,b.dataset.name);
        });
      } else {
        restore(); return;
      }
      reinsert(list);
    }

    buttons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = btn.dataset.key;
        if (activeKey === key){
          activeKey = null;
          buttons.forEach(b=>b.classList.remove('active'));
          restore();
        } else {
          activeKey = key;
          buttons.forEach(b=>b.classList.toggle('active', b===btn));
          sortBy(key);
        }
      });
    });
  })();
  </script>

  <style>
    /* 75% page scale (Chrome/Edge/Safari) */
    html { zoom: .75; }     /* non-standard, but widely supported */
  </style>
</body>
</html>
