<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YAS Booklet</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #fff;
      color: #000;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    .nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }

    .btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #444;
      text-decoration: none;
      color: #000;
      background: #E1C233;
      font-weight: 600;
    }

    .btn.disabled {
      opacity: .4;
      pointer-events: none;
    }
  </style>
</head>

<body>

<div class="wrap">
  <div class="nav">
    <div>
      <b>YAS Booklet</b> — Page {{ page }} / {{ max_page }}
    </div>

    <div style="display:flex; gap:10px;">
      <a class="btn" href="{{ url_for('home.role_selection') }}">Home</a>

      {% if page > 1 %}
        <a class="btn" href="{{ url_for('yas_booklet.yas_page', page=page-1) }}">← Prev</a>
      {% else %}
        <span class="btn disabled">← Prev</span>
      {% endif %}

      {% if page < max_page %}
        <a class="btn" href="{{ url_for('yas_booklet.yas_page', page=page+1) }}">Next →</a>
      {% else %}
        <span class="btn disabled">Next →</span>
      {% endif %}
    </div>
    <form id="jumpForm" style="display:flex; gap:6px; align-items:center;">
      <input type="number"
            id="jumpPage"
            min="1"
            max="{{ max_page }}"
            placeholder="Page"
            style="width:70px; padding:6px;">
      <button type="submit" class="btn">Go</button>
    </form>
  </div>

  <div class="booklet">
    {{ content_html | safe }}
  </div>
</div>

<script>
(function () {

  const PAGE_CODE = "{{ '%03d'|format(page) }}";
  const SAVED_DATA = JSON.parse('{{ saved_data | tojson | safe }}');

  const LOGIN_DATA = {
    trainee_name: "{{ session.get('training_employee_name','') }}",
    trainee_role: "{{ session.get('training_employee_role','') }}"
  };

  const fields = document.querySelectorAll(
    "input[name], textarea[name], select[name]"
  );

  // ================= RESTORE VALUES =================
  fields.forEach(el => {

    if (SAVED_DATA.hasOwnProperty(el.name)) {

      if (el.type === "radio") {
        el.checked = (el.value === SAVED_DATA[el.name]);
      } else if (el.type === "checkbox") {
        el.checked = SAVED_DATA[el.name] === "true";
      } else {
        el.value = SAVED_DATA[el.name];
      }

    } else if (!el.value && LOGIN_DATA.hasOwnProperty(el.name)) {
      el.value = LOGIN_DATA[el.name];
    }

  });

  // ================= AUTOSAVE =================
  let timer = null;

  function autosave(el) {
    fetch("/training/autosave", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        page_code: PAGE_CODE,
        field: el.name,
        value:
          el.type === "checkbox"
            ? String(el.checked)
            : el.value
      })
    });
  }

  fields.forEach(el => {

    const handler = () => {
      clearTimeout(timer);
      timer = setTimeout(() => autosave(el), 200);
    };

    // text, textarea
    el.addEventListener("input", handler);

    // radio, checkbox, select
    el.addEventListener("change", handler);

  });

})();
</script>
<script>
  document.getElementById("jumpForm")?.addEventListener("submit", function (e) {
    e.preventDefault();

    const page = Number(document.getElementById("jumpPage").value);
    const max = Number("{{ max_page }}");   // ✅ SAFE

    if (!page || page < 1 || page > max) {
      alert("Invalid page number");
      return;
    }

    window.location.href = "/yas/" + page;
  });
</script>

</body>
</html>
