<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YOD • Daily Deep Dive</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-top:#2b0050; --bg-bottom:#0b0920;
    --panel:#0f0d22; --panel-2:#120f27;
    --text:#EAF4FF; --muted:#9aa4b2;
    --accent:#00F0FF; --accent-2:#B06CFF; --ring:#2c2a45;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Montserrat,system-ui,Arial;
    color:var(--text);
    background: radial-gradient(1200px 600px at 20% -10%, #5a1da6 0%, transparent 60%),
                linear-gradient(180deg, var(--bg-top), var(--bg-bottom));
    background-attachment: fixed;
  }
  .wrap{max-width:1200px; margin:24px auto 72px; padding:0 16px}

  .titlebar{display:flex; align-items:center; gap:14px; margin-bottom:14px}
  .back{width:40px; height:40px; border-radius:999px; display:grid; place-items:center;
        background:transparent; border:2px solid var(--ring); color:var(--text);
        cursor:pointer; transition:.2s transform}
  .back:hover{transform:translateX(-2px)}
  .h1{font-weight:800; font-size:28px; letter-spacing:.5px; text-shadow:0 0 20px rgba(0,240,255,.25)}
  .sub{color:var(--muted); margin-left:auto; font-weight:600}

  .panel{
    margin-top:18px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)), var(--panel);
    border:1px solid var(--ring); border-radius:18px; padding:18px;
    box-shadow: 0 6px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(0,0,0,.25);
  }

  /* charts */
  canvas{height:auto; display:block}
  .baseline{position:relative}
  .baseline:before{content:""; position:absolute; left:0; right:0; top:50%; border-top:1px dashed rgba(255,255,255,.15)}
  .term-grid{display:grid; gap:16px; grid-template-columns:1fr; margin-top:8px}
  @media (min-width:900px){ .term-grid{grid-template-columns:repeat(3,1fr)} }
  .term-grid.two { grid-template-columns:1fr }
  @media (min-width:900px){ .term-grid.two{ grid-template-columns:repeat(2,1fr) } }

  /* manning cards */
  .cards{display:grid; gap:16px; grid-template-columns:1fr; margin-top:18px}
  @media (min-width:900px){ .cards{grid-template-columns:repeat(4,1fr)} }
  .cards.two{ grid-template-columns:1fr }
  @media (min-width:900px){ .cards.two{ grid-template-columns:repeat(2,1fr) } }
  .card{background:var(--panel-2); border:1px solid var(--ring); border-radius:16px; overflow:hidden}
  .card header{padding:12px 14px; font-weight:800; border-bottom:1px solid var(--ring)}
  .rows{padding:8px 0}
  .row{display:grid; grid-template-columns:1.4fr .8fr; padding:8px 14px; gap:10px; align-items:center}
  .row:nth-child(odd){background:rgba(255,255,255,.02)}
  .row span:first-child{color:var(--muted)}
  .row span:last-child{justify-self:end; font-weight:700}

  /* segmented control */
  .seg{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px}
  .seg-btn{
    background:#151332; border:1px solid var(--ring); color:#EAF4FF;
    padding:10px 14px; border-radius:12px; font-weight:800; letter-spacing:.3px;
    box-shadow:inset 0 0 0 1px rgba(176,108,255,.18); cursor:pointer
  }
  .seg-btn.active{ outline:2px solid var(--accent); box-shadow:0 0 16px rgba(0,240,255,.25) }

  /* kpis / HSL block (unchanged) */
  .kpi-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin: 0 16px }
  .neo-card{ background:var(--panel-2); border:1px solid var(--ring); border-radius:14px; box-shadow:inset 0 0 0 1px rgba(0,0,0,.15) }
  .kpi{ padding:16px }
  .kpi-title{ color:var(--muted); font-weight:700; font-size:12px }
  .kpi-val{ margin-top:6px; font-weight:800; font-size:16px }
  .kpi-val.good{ color:#6DFFBD } .kpi-val.warn{ color:#FFD65A }
  .hsl-grid{ display:grid; gap:18px; grid-template-columns:1fr; margin-top:16px }
  @media (min-width:980px){ .hsl-grid{ grid-template-columns: 1.1fr 1.4fr } }
  .left{ display:flex; flex-direction:column; gap:16px }
  .donut-row{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
  .donut-card header{ padding:12px 14px; border-bottom:1px solid var(--ring); font-weight:800 }
  .donut-wrap{ display:flex; align-items:center; gap:14px; padding:12px 14px }
  .donut-legend{ display:flex; flex-direction:column; gap:8px; font-size:13px;}
  .dot{ display:inline-block; width:10px; height:10px; border-radius:999px; margin-right:8px }
  .dot.pass{ background:#43FF93; box-shadow:0 0 12px rgba(67,255,147,.45) }
  .dot.fail{ background:#FF647C; box-shadow:0 0 12px rgba(255,100,124,.45) }
  .donut-wrap canvas{ width: 240px !important; height: 240px !important; flex: 0 0 240px; }
  .mini header{ padding:10px 14px; border-bottom:1px solid var(--ring); font-weight:800 }
  .mini-rows{ padding:8px 14px }
  .mini-row{ display:grid; grid-template-columns:1.1fr .7fr .7fr .7fr; padding:8px 0; align-items:center }
  .mini-row span:first-child{ color:var(--muted) }
  .mini-row span:not(:first-child){ justify-self:end; font-weight:700 }
  .mini-row.mini-head{ color:#B9C2D0; font-weight:800; border-bottom:1px solid rgba(255,255,255,.08); padding-bottom:6px; margin-bottom:6px }
  .score{ text-align:center; padding:6px 0 4px }
  .score-label{ color:#9aa4b2; font-weight:700; letter-spacing:.3px }
  .score-val{ font-weight:900; font-size:44px; letter-spacing:1px; color:#FFD65A; text-shadow: 0 0 20px rgba(255,214,90,.35) }
  .right header{ padding:12px 14px; border-bottom:1px solid var(--ring); font-weight:800 }
  .tbl-wrap{ max-height:420px; overflow:auto }
  .hsl-table{ width:100%; border-collapse:separate; border-spacing:0 }
  .hsl-table thead th{ position:sticky; top:0; background:#161432; z-index:1; font-size:12px; text-align:left; padding:10px 12px; color:#B9C2D0; border-bottom:1px solid var(--ring) }
  .hsl-table tbody td{ padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); font-size:13px }
  .badge{ padding:3px 8px; border-radius:999px; font-weight:800; font-size:11px; letter-spacing:.4px }
  .badge.pass{ background:rgba(67,255,147,.12); color:#43FF93; border:1px solid rgba(67,255,147,.35) }
  .badge.fail{ background:rgba(255,100,124,.12); color:#FF647C; border:1px solid rgba(255,100,124,.35) }
</style>
</head>
<body>
  <div class="wrap">
    <div class="titlebar">
      <button class="back" onclick="history.back()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="h1" id="pageTitle">{{ the_date_string }} {{ the_shift }}</div>
      <div class="sub" id="pageMeta">Daily · P123</div>
    </div>

    <!-- Overview -->
    <div class="panel baseline">
      <h2>Overview</h2>
      <div style="height:260px"><canvas id="overview" height="260"></canvas></div>
    </div>

    <!-- Dynamic PPT charts -->
    <div class="term-grid" id="termGrid"><!-- built by JS --></div>

    <!-- Manning & Equipment -->
    <div class="panel" style="margin-top:24px; text-align:center">
      <h2 style="display:inline-block; padding:6px 18px; border:2px solid #ffd65a; border-radius:999px; box-shadow:0 0 18px rgba(255,214,90,.3);">Manning &amp; Equipment</h2>
      <div class="cards" id="manningCards"><!-- built by JS --></div>
    </div>
  </div>

  <!-- KPI row -->
  <div class="kpi-grid">
    <div class="kpi neo-card"><div class="kpi-title">Gate Ops</div><div class="kpi-val">No Problem</div></div>
    <div class="kpi neo-card"><div class="kpi-title">Available Manpower › Today Demand</div><div class="kpi-val good">Balanced</div></div>
    <div class="kpi neo-card"><div class="kpi-title">Today Demand › Available Manpower</div><div class="kpi-val warn">Tight</div></div>
    <div class="kpi neo-card"><div class="kpi-title">Safety</div><div class="kpi-val">No Problem</div></div>
  </div>

  <!-- HSL block -->
  <div class="panel hsl-panel" style="margin: 18px 16px;">
    <div class="hsl-top">
      <div class="seg" id="hslSeg"><!-- buttons injected by JS --></div>
      <div class="hsl-grid">
        <div class="left">
          <div class="donut-row">
            <div class="donut-card neo-card">
              <header>Mount</header>
              <div class="donut-wrap">
                <canvas id="donutMount" width="220" height="220"></canvas>
                <div class="donut-legend">
                  <div class="legend-item"><span class="dot pass"></span><span>Pass</span></div>
                  <div class="legend-item"><span class="dot fail"></span><span>Fail</span></div>
                </div>
              </div>
            </div>
            <div class="donut-card neo-card">
              <header>Offload</header>
              <div class="donut-wrap">
                <canvas id="donutOff" width="220" height="220"></canvas>
                <div class="donut-legend">
                  <div class="legend-item"><span class="dot pass"></span><span>Pass</span></div>
                  <div class="legend-item"><span class="dot fail"></span><span>Fail</span></div>
                </div>
              </div>
            </div>
          </div>

          <div class="mini neo-card">
            <header>HSL Summary</header>
            <div class="mini-rows">
              <div class="mini-row mini-head"><span>Type</span><span>Pass</span><span>Fail</span><span>Total</span></div>
              <div class="mini-row"><span>Mount</span><span id="mini-m-pass">—</span><span id="mini-m-fail">—</span><span id="mini-m-total">—</span></div>
              <div class="mini-row"><span>Offload</span><span id="mini-o-pass">—</span><span id="mini-o-fail">—</span><span id="mini-o-total">—</span></div>
            </div>
          </div>

          <div class="score">
            <div class="score-label">Overall Pass Rate</div>
            <div class="score-val" id="scorePct">0%</div>
          </div>
        </div>

        <div class="right neo-card">
          <header>Event Log</header>
          <div class="tbl-wrap">
            <table class="hsl-table" id="hslTable">
              <thead>
                <tr>
                  <th>GateOpsType</th><th>Start</th><th>End</th><th>Haulier</th><th>Service</th><th>Type</th><th>Location</th><th>Result</th>
                </tr>
              </thead>
              <tbody><!-- filled by JS --></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- ======== SERVER PAYLOAD ======== -->
  <script id="server-payload" type="application/json">
    {{ payload | tojson }}
  </script>

  <!-- ======== CORE JS (cluster-aware + P56SE alias) ======== -->
  <script>
    const _srvEl = document.getElementById('server-payload');
    let PAYLOAD = {};
    try { PAYLOAD = JSON.parse((_srvEl.textContent || '').trim() || '{}'); } catch(e){ PAYLOAD = {}; }

    // cluster
    const qs = new URLSearchParams(location.search);
    let CLUSTER = (qs.get('cluster') || 'P123').toUpperCase();
    if (CLUSTER !== 'P123' && CLUSTER !== 'P456') CLUSTER = 'P123';
    (function () {
      var meta = document.getElementById('pageMeta');
      if (meta) meta.textContent = 'Daily · ' + CLUSTER;
    })();

    // --- Canonicalize keys so P56SE or PPT56SE both work ---
    function normalizeP56(obj){
      if (!obj || typeof obj!=='object') return {};
      const out = {...obj};
      if (obj['P56SE'] && !obj['PPT56SE']) out['PPT56SE'] = obj['P56SE'];
      return out;
    }

    const HOURS = (PAYLOAD.hours || ['7:00','8:00','9:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00']);
    const OVR   = (PAYLOAD.overview  || {mounting:[], avg:[], offload:[]});
    const TERMS = normalizeP56(PAYLOAD.terminals || {}); // {PPT1.., PPT4, PPT56SE}
    const THEME = getComputedStyle(document.documentElement);
    const COLORS = {
      mounting: (THEME.getPropertyValue('--accent')   || '#00F0FF').trim(),
      offload:  (THEME.getPropertyValue('--accent-2') || '#B06CFF').trim(),
      avg:      '#FFD65A'
    };
    Chart.defaults.color = '#cfd5e3';
    Chart.defaults.borderColor = 'rgba(255,255,255,0.08)';

    const Glow = { id:'glow', afterDatasetsDraw(chart){
      const ctx = chart.ctx;
      (chart.data.datasets||[]).forEach((ds,i)=>{
        const meta = chart.getDatasetMeta(i); if(!meta || !meta.dataset) return;
        ctx.save(); ctx.shadowColor = ds.borderColor||COLORS.mounting; ctx.shadowBlur = 18;
        ctx.lineWidth = ds.borderWidth||2; meta.dataset.draw(ctx); ctx.restore();
      });
    }};

    function mkTripleConfig(series) {
      const s = series || {mounting:[], avg:[], offload:[]};
      const toNums = a => (a || []).map(v => (v==null ? null : Number(v)));
      return {
        type: 'line',
        plugins:[Glow],
        data: {
          labels: HOURS,
          datasets: [
            { label:'Mounting', data: toNums(s.mounting), borderColor: COLORS.mounting, tension:0.35, borderWidth:2, pointRadius:3, pointHoverRadius:6 },
            { label:'Average Wait Time', data: toNums(s.avg), borderColor: COLORS.avg, borderDash:[6,6], tension:0.35, borderWidth:2, pointRadius:0, pointHoverRadius:0 },
            { label:'Offloading', data: toNums(s.offload), borderColor: COLORS.offload, tension:0.35, borderWidth:2, pointRadius:3, pointHoverRadius:6 }
          ]
        },
        options: {
          responsive:true, maintainAspectRatio:false,
          interaction:{ mode:'nearest', intersect:false },
          scales:{
            x:{ grid:{ color:'rgba(255,255,255,.06)' } },
            y:{ grid:{ color:'rgba(255,255,255,.06)' }, suggestedMin:5, suggestedMax:15, ticks:{ stepSize:1 } }
          },
          plugins:{ legend:{ display:false } }
        }
      };
    }

    // overview
    new Chart(document.getElementById('overview'), mkTripleConfig(OVR));

    // build terminal charts dynamically
    (function buildTermCharts(){
      const grid = document.getElementById('termGrid');
      const setP123 = ['PPT1','PPT2','PPT3'];
      const setP456 = ['PPT4','PPT56SE'];
      const want = (CLUSTER === 'P456') ? setP456 : setP123;

      grid.classList.toggle('two', want.length === 2);
      grid.innerHTML = '';
      want.forEach(key => {
        const card = document.createElement('div');
        card.className = 'panel baseline';
        card.innerHTML = `<h2>${key}</h2><div style="height:200px"><canvas id="t-${key}" height="200"></canvas></div>`;
        grid.appendChild(card);
        const series = TERMS[key] || {};
        new Chart(document.getElementById(`t-${key}`), mkTripleConfig(series));
      });
    })();
  </script>

  <!-- ======== FALLBACK DUMMY (P123 manning only) ======== -->
  <script>
    var __FALLBACK_PAYLOAD__ = (function(){
      var hours = ['7:00','8:00','9:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00'];
      function S(a){ return a.slice(); }
      var overview = {
        mounting: S([12.8,10.2, 9.9,11.5,12.3,11.8, 9.6, 8.7,12.8,11.6,10.3, 7.9,12.5]),
        offload:  S([12.8,11.3,14.5,12.8,12.3,11.5, 8.6, 9.7,12.8,11.4,10.3, 6.5,12.8]),
        avg:      S([11.2,10.1,10.3,11.0,11.8,10.8, 9.3, 9.9,11.2,10.7,10.6, 8.4,12.0])
      };
      function pack(m,o,a){ return { mounting:S(m), offload:S(o), avg:S(a) }; }

      return {
        hours: hours,
        overview: overview,
        terminals: {
          PPT1: pack([11,9,12,8,10,14,13,12,9,8,7,5,6],
                     [ 9,10,8,12,11,10,13,12,12,9,8,7,10],
                     [10,9.5,10,9.8,10.5,10.6,9.9,10.1,10.3,9.9,9.8,9.7,10.2]),
          PPT2: pack([13,12,9,9,8,9,10,11,10,10,11,13,14],
                     [12, 9,8,10,10,9,10,11,12,11,12,12,10],
                     [ 9.5,9.2,9.0,9.3,9.6,9.8,9.7,9.9,10.3,10.2,10.1,10.0,10.4]),
          PPT3: pack([12,15,13,12,11,10,9,11,12,13,14,15,13],
                     [10,11, 9, 8, 9,10,12,13,10,12,11,12,12],
                     [ 9.8,9.9,10.2,10.5,10.1, 9.7,9.5,10.0,10.4,10.7,10.9,11.2,10.8])
        },
        // Dummy manning ONLY for P123
        manning_p123:{
          bc:   [["Adjusted Deployment","11"],["Available Manpower","11"],["Max Deployable Fleet","12"],["Previous Forecast","11"],["Today Demand","13"]],
          ppt2: [["Adjusted Deployment","48/47+1 SAMSUNG | 11"],["Available Manpower","64/63+1 SAMSUNG"],["Max Deployable Fleet","49 | 11"],["Previous Forecast","51 | 13"],["Today Demand","51 | 13"]],
          ppt3: [["Adjusted Deployment","58/57+1 DOOSAN"],["Available Manpower","55/54+1 DOOSAN"],["Max Deployable Fleet","58"],["Previous Forecast","57"],["Today Demand","57"]],
          fm:   [["Adjusted Deployment","15+4 EDO"],["Available Manpower","19"],["Max Deployable Fleet","21 +1 TLOAN"],["Previous Forecast","24"],["Today Demand","19"]]
        }
      };
    })();
  </script>

  <!-- ======== HYDRATE MANNING CARDS (cluster-aware) ======== -->
  <script>
    (function () {
      var server = PAYLOAD && Object.keys(PAYLOAD).length ? PAYLOAD : __FALLBACK_PAYLOAD__;
      var cardsWrap = document.getElementById('manningCards');

      function fillRows(id, rowsArr){
        var c=document.getElementById(id); if(!c) return; c.innerHTML='';
        (rowsArr||[]).forEach(function(p){
          var r=document.createElement('div'); r.className='row';
          r.innerHTML='<span>'+p[0]+'</span><span>'+p[1]+'</span>';
          c.appendChild(r);
        });
      }

      if (CLUSTER === 'P456') {
        // only PPT4 & PPT56SE cards
        cardsWrap.classList.add('two');
        cardsWrap.innerHTML =
          '<div class="card"><header>PPT4</header><div class="rows" id="card-ppt4"></div></div>'+
          '<div class="card"><header>PPT56SE</header><div class="rows" id="card-ppt56se"></div></div>';
        var m = (server.manning_p456 || server.manning || {});
        if (m.ppt4 || m.PPT4)     fillRows('card-ppt4',     m.ppt4 || m.PPT4);
        var m56 = m.ppt56se || m.PPT56SE || m.p56se || m.P56SE || [];
        fillRows('card-ppt56se', m56);
      } else {
        // P123: use dummy
        cardsWrap.classList.remove('two');
        cardsWrap.innerHTML =
          '<div class="card"><header>BC</header><div class="rows" id="card-bc"></div></div>'+
          '<div class="card"><header>PPT2 (Sect 1 / 2)</header><div class="rows" id="card-ppt2"></div></div>'+
          '<div class="card"><header>PPT3</header><div class="rows" id="card-ppt3"></div></div>'+
          '<div class="card"><header>FM</header><div class="rows" id="card-fm"></div></div>';

        var m = (server.manning_p123 || __FALLBACK_PAYLOAD__.manning_p123 || {});
        fillRows('card-bc',  m.bc);
        fillRows('card-ppt2',m.ppt2);
        fillRows('card-ppt3',m.ppt3);
        fillRows('card-fm',  m.fm);
      }
    })();
  </script>

  <!-- ======== HSL (cluster-aware tabs + donuts/table) ======== -->
  <script>
    // Center text plugin for donuts
    var CenterText = {
      id:'centerText',
      afterDatasetsDraw: function(chart, args, opts){
        var ctx = chart.ctx, v = opts && opts.text ? String(opts.text) : '';
        if (!v) return;
        ctx.save();
        ctx.font = '800 22px Montserrat, Arial, sans-serif';
        ctx.fillStyle = '#EAF4FF';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        var p = chart.getDatasetMeta(0).data[0];
        if (!p) { ctx.restore(); return; }
        ctx.fillText(v, p.x, p.y);
        ctx.restore();
      }
    };

    function makeDonut(id, passCount, failCount, pctText){
      var el = document.getElementById(id); if(!el) return null;
      var existing = Chart.getChart(el);
      var data = { labels:['Pass','Fail'], datasets:[{ data:[passCount, failCount], backgroundColor:['#43FF93','#FF647C'], hoverOffset:4, borderWidth:0 }] };
      var common = { type:'doughnut', data:data, plugins:[CenterText],
        options:{ cutout:'62%', animation:{ animateRotate:true, animateScale:true, duration:900, easing:'easeOutQuart' }, plugins:{ legend:{ display:false }, centerText:{ text:pctText } } }
      };
      if (existing){ existing.options.plugins.centerText.text = pctText; existing.data = data; existing.update(); return existing; }
      return new Chart(el, common);
    }

    // HSL terminals from payload (normalize P56SE)
    var HSL_TERMS = normalizeP56((PAYLOAD && PAYLOAD.hsl && PAYLOAD.hsl.terminals) ? PAYLOAD.hsl.terminals : {});

    // Build cluster-aware segmented tabs
    (function initSeg(){
      var seg = document.getElementById('hslSeg');
      var keysAll = Object.keys(HSL_TERMS);
      var SET_P123 = ['PPT1','PPT2','PPT3'];
      var SET_P456 = ['PPT4','PPT56SE'];

      var keys;
      if (CLUSTER === 'P456') {
        keys = SET_P456.filter(k => keysAll.includes(k));
        if (!keys.length) keys = SET_P456; // show tabs even if empty
      } else {
        keys = SET_P123.filter(k => keysAll.includes(k));
        if (!keys.length) keys = SET_P123;
      }

      seg.innerHTML = '';
      keys.forEach(function(k, idx){
        var b = document.createElement('button');
        b.className = 'seg-btn' + (idx===0 ? ' active' : '');
        b.dataset.key = k;
        b.textContent = k + ' HSL';
        seg.appendChild(b);
      });

      var first = seg.querySelector('.seg-btn');
      if (first) { fillMiniAndTable(first.dataset.key); }
    })();

    function fillMiniAndTable(key){
      var d = HSL_TERMS[key] || null;
      if (!d){ d = { mount:{pass:0, fail:0, total:0}, off:{pass:0, fail:0, total:0}, rows:[], pass_rate:0 }; }
      var mPass = Number(d.mount?.pass||0), mFail = Number(d.mount?.fail||0), mTot = Number(d.mount?.total|| (mPass+mFail));
      var oPass = Number(d.off?.pass||0),   oFail = Number(d.off?.fail||0),   oTot = Number(d.off?.total|| (oPass+oFail));

      document.getElementById('mini-m-pass').textContent = mPass;
      document.getElementById('mini-m-fail').textContent = mFail;
      document.getElementById('mini-m-total').textContent = mTot;
      document.getElementById('mini-o-pass').textContent = oPass;
      document.getElementById('mini-o-fail').textContent = oFail;
      document.getElementById('mini-o-total').textContent = oTot;

      var mPct = mTot ? Math.round((mPass/mTot)*100) : 0;
      var oPct = oTot ? Math.round((oPass/oTot)*100) : 0;
      makeDonut('donutMount', mPass, mFail, mPct + '%');
      makeDonut('donutOff',   oPass, oFail, oPct + '%');

      var allTot = mTot + oTot, allPass = mPass + oPass;
      var allPct = allTot ? Math.round((allPass/allTot)*1000)/10 : 0;
      document.getElementById('scorePct').textContent = allPct.toFixed(1) + '%';

      var tb = document.querySelector('#hslTable tbody');
      tb.innerHTML = '';
      var rows = Array.isArray(d.rows) ? d.rows : [];
      if (!rows.length){
        var other = Object.keys(HSL_TERMS).find(t => (HSL_TERMS[t]?.rows||[]).length);
        if (other) rows = HSL_TERMS[other].rows;
      }
      rows.forEach(function(r){
        var tr = document.createElement('tr');
        var resPass = String(r.result||'').toLowerCase()==='pass';
        tr.innerHTML =
          '<td>'+ (r.type||'')   +'</td>'+
          '<td>'+ (r.start||'')  +'</td>'+
          '<td>'+ (r.end||'')    +'</td>'+
          '<td>'+ (r.haulier||'')+'</td>'+
          '<td>'+ (r.svc||'')    +'</td>'+
          '<td>'+ (r.ctype||'')  +'</td>'+
          '<td>'+ (r.loc||'')    +'</td>'+
          '<td><span class="badge '+(resPass?'pass':'fail')+'">'+(resPass?'Pass':'Fail')+'</span></td>';
        tb.appendChild(tr);
      });
    }

    (function wireSeg(){
      var seg = document.getElementById('hslSeg');
      seg.addEventListener('click', function(e){
        var b = e.target.closest('.seg-btn'); if(!b) return;
        Array.prototype.forEach.call(seg.children, function(x){ x.classList.remove('active'); });
        b.classList.add('active');
        fillMiniAndTable(b.dataset.key);
      });
    })();
  </script>
</body>
</html>
