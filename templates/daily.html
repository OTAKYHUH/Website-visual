<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YOD • Daily Deep Dive</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-top:#2b0050; --bg-bottom:#0b0920;
    --panel:#0f0d22; --panel-2:#120f27;
    --text:#EAF4FF; --muted:#9aa4b2;
    --accent:#00F0FF; --accent-2:#B06CFF; --ring:#2c2a45;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Montserrat,system-ui,Arial;
    color:var(--text);
    background: radial-gradient(1200px 600px at 20% -10%, #5a1da6 0%, transparent 60%),
                linear-gradient(180deg, var(--bg-top), var(--bg-bottom));
    background-attachment: fixed;
  }
  .wrap{max-width:1200px; margin:24px auto 72px; padding:0 16px}

  .titlebar{display:flex; align-items:center; gap:14px; margin-bottom:14px}
  .back{width:40px; height:40px; border-radius:999px; display:grid; place-items:center;
        background:transparent; border:2px solid var(--ring); color:var(--text);
        cursor:pointer; transition:.2s transform}
  .back:hover{transform:translateX(-2px)}
  .h1{font-weight:800; font-size:28px; letter-spacing:.5px; text-shadow:0 0 20px rgba(0,240,255,.25)}
  .sub{color:var(--muted); margin-left:auto; font-weight:600}

  .panel{
    margin-top:18px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)), var(--panel);
    border:1px solid var(--ring); border-radius:18px; padding:18px;
    box-shadow: 0 6px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(0,0,0,.25);
  }

  /* chips + CTA */
  .chipbar{background:rgba(0,0,0,.15); border:1px solid var(--ring); border-radius:18px; padding:10px; overflow:auto; display:flex; gap:10px}
  .pill{flex:0 0 auto; padding:10px 14px; border-radius:14px; background:#1a1735; border:1px solid var(--ring); font-weight:700; font-size:13px; letter-spacing:.3px; box-shadow:inset 0 0 0 1px rgba(176,108,255,.2); color:#fff; cursor:pointer}
  .pill.active{outline:2px solid var(--accent); box-shadow:0 0 18px rgba(0,240,255,.25)}
  .cta{display:block; width:260px; margin:14px auto 0; padding:14px 18px; text-align:center; border-radius:999px; font-weight:800; letter-spacing:.4px; color:#fff; background:linear-gradient(135deg, var(--accent), var(--accent-2)); border:0; text-decoration:none}

  /* charts */
  canvas{height:auto; display:block}
  .baseline{position:relative}
  .baseline:before{content:""; position:absolute; left:0; right:0; top:50%; border-top:1px dashed rgba(255,255,255,.15)}
  .grid-3{display:grid; gap:16px; grid-template-columns:1fr; margin-top:8px}
  @media (min-width:900px){ .grid-3{grid-template-columns:repeat(3,1fr)} }

  /* manning cards */
  .cards{display:grid; gap:16px; grid-template-columns:1fr; margin-top:18px}
  @media (min-width:900px){ .cards{grid-template-columns:repeat(4,1fr)} }
  .card{background:var(--panel-2); border:1px solid var(--ring); border-radius:16px; overflow:hidden}
  .card header{padding:12px 14px; font-weight:800; border-bottom:1px solid var(--ring)}
  .rows{padding:8px 0}
  .row{display:grid; grid-template-columns:1.4fr .8fr; padding:8px 14px; gap:10px; align-items:center}
  .row:nth-child(odd){background:rgba(255,255,255,.02)}
  .row span:first-child{color:var(--muted)}
  .row span:last-child{justify-self:end; font-weight:700}
  /* segmented control */
.seg{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px}
.seg-btn{
  background:#151332; border:1px solid var(--ring); color:#EAF4FF;
  padding:10px 14px; border-radius:12px; font-weight:800; letter-spacing:.3px;
  box-shadow:inset 0 0 0 1px rgba(176,108,255,.18); cursor:pointer
}
.seg-btn.active{ outline:2px solid var(--accent); box-shadow:0 0 16px rgba(0,240,255,.25) }

/* kpis */
.kpi-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px }
.neo-card{ background:var(--panel-2); border:1px solid var(--ring); border-radius:14px; box-shadow:inset 0 0 0 1px rgba(0,0,0,.15) }
.kpi{ padding:16px }
.kpi-title{ color:var(--muted); font-weight:700; font-size:12px }
.kpi-val{ margin-top:6px; font-weight:800; font-size:16px }
.kpi-val.good{ color:#6DFFBD } .kpi-val.warn{ color:#FFD65A }

/* layout */
.hsl-grid{ display:grid; gap:18px; grid-template-columns:1fr; margin-top:16px }
@media (min-width:980px){ .hsl-grid{ grid-template-columns: 1.1fr 1.4fr } }
.left{ display:flex; flex-direction:column; gap:16px }

/* donuts */
.donut-row{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
.donut-card header{ padding:12px 14px; border-bottom:1px solid var(--ring); font-weight:800 }
.donut-wrap{ display:flex; align-items:center; gap:14px; padding:12px 14px }
.donut-legend{ display:flex; flex-direction:column; gap:8px; font-size:13px; color:var(--muted) }
.dot{ display:inline-block; width:10px; height:10px; border-radius:999px; margin-right:8px }
.dot.pass{ background:#43FF93; box-shadow:0 0 12px rgba(67,255,147,.45) }
.dot.fail{ background:#FF647C; box-shadow:0 0 12px rgba(255,100,124,.45) }

/* mini summary table */
.mini header{ padding:10px 14px; border-bottom:1px solid var(--ring); font-weight:800 }
.mini-rows{ padding:8px 14px }
.mini-row{ display:grid; grid-template-columns:1.1fr .7fr .7fr .7fr; padding:8px 0; align-items:center }
.mini-row span:first-child{ color:var(--muted) }
.mini-row span:not(:first-child){ justify-self:end; font-weight:700 }

/* big score */
.score{ text-align:center; padding:6px 0 4px }
.score-label{ color:var(--muted); font-weight:700; letter-spacing:.3px }
.score-val{ font-weight:900; font-size:44px; letter-spacing:1px; color:#FFD65A;
  text-shadow: 0 0 20px rgba(255,214,90,.35) }

/* table */
.right header{ padding:12px 14px; border-bottom:1px solid var(--ring); font-weight:800 }
.tbl-wrap{ max-height:420px; overflow:auto }
.hsl-table{ width:100%; border-collapse:separate; border-spacing:0 }
.hsl-table thead th{
  position:sticky; top:0; background:#161432; z-index:1;
  font-size:12px; text-align:left; padding:10px 12px; color:#B9C2D0; border-bottom:1px solid var(--ring)
}
.hsl-table tbody td{
  padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);
  font-size:13px
}
.badge{
  padding:3px 8px; border-radius:999px; font-weight:800; font-size:11px; letter-spacing:.4px
}
.badge.pass{ background:rgba(67,255,147,.12); color:#43FF93; border:1px solid rgba(67,255,147,.35) }
.badge.fail{ background:rgba(255,100,124,.12); color:#FF647C; border:1px solid rgba(255,100,124,.35) }
</style>
</head>
<body>
  <div class="wrap">
    <div class="titlebar">
      <button class="back" onclick="history.back()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="h1" id="pageTitle">{{ the_date_string }} {{ the_shift }}</div>
      <div class="sub" id="pageMeta">Daily · P123</div>
    </div>

    <!-- Overview -->
    <div class="panel baseline">
      <h2>Overview</h2>
      <div style="height:260px"><canvas id="overview" height="260"></canvas></div>
    </div>

    <!-- PPT1/2/3 -->
    <div class="grid-3">
      <div class="panel baseline"><h2>PPT1</h2><div style="height:200px"><canvas id="ppt1" height="200"></canvas></div></div>
      <div class="panel baseline"><h2>PPT2</h2><div style="height:200px"><canvas id="ppt2" height="200"></canvas></div></div>
      <div class="panel baseline"><h2>PPT3</h2><div style="height:200px"><canvas id="ppt3" height="200"></canvas></div></div>
    </div>

    <!-- Manning & Equipment -->
    <div class="panel" style="margin-top:24px; text-align:center">
      <h2 style="display:inline-block; padding:6px 18px; border:2px solid #ffd65a; border-radius:999px; box-shadow:0 0 18px rgba(255,214,90,.3);">Manning &amp; Equipment</h2>
      <div class="cards">
        <div class="card"><header>BC</header><div class="rows" id="card-bc"></div></div>
        <div class="card"><header>PPT2 (Sect 1 / 2)</header><div class="rows" id="card-ppt2"></div></div>
        <div class="card"><header>PPT3</header><div class="rows" id="card-ppt3"></div></div>
        <div class="card"><header>FM</header><div class="rows" id="card-fm"></div></div>
      </div>
    </div>
  </div>
  <div class="kpi-grid">
      <div class="kpi neo-card">
        <div class="kpi-title">Gate Ops</div>
        <div class="kpi-val">No Problem</div>
      </div>
      <div class="kpi neo-card">
        <div class="kpi-title">Available Manpower › Today Demand</div>
        <div class="kpi-val good">Balanced</div>
      </div>
      <div class="kpi neo-card">
        <div class="kpi-title">Today Demand › Available Manpower</div>
        <div class="kpi-val warn">Tight</div>
      </div>
      <div class="kpi neo-card">
        <div class="kpi-title">Safety</div>
        <div class="kpi-val">No Problem</div>
      </div>
    </div>
  </div>
  <div class="panel hsl-panel">
  <div class="hsl-top">
    <div class="seg" id="hslSeg">
      <button class="seg-btn active" data-key="PPT1">PPT1 HSL</button>
      <button class="seg-btn" data-key="PPT2">PPT2 HSL</button>
      <button class="seg-btn" data-key="PPT3">PPT3 HSL</button>
    </div>

  <div class="hsl-grid">
    <!-- Left: donuts + mini table + big % -->
    <div class="left">
      <div class="donut-row">
        <div class="donut-card neo-card">
          <header>Mount</header>
          <div class="donut-wrap">
            <canvas id="donutMount" width="220" height="220"></canvas>
            <div class="donut-legend">
              <span class="dot pass"></span> Pass
              <span class="dot fail"></span> Fail
            </div>
          </div>
        </div>
        <div class="donut-card neo-card">
          <header>Offload</header>
          <div class="donut-wrap">
            <canvas id="donutOff" width="220" height="220"></canvas>
            <div class="donut-legend">
              <span class="dot pass"></span> Pass
              <span class="dot fail"></span> Fail
            </div>
          </div>
        </div>
      </div>

      <div class="mini neo-card">
        <header>HSL Summary</header>
        <div class="mini-rows">
          <div class="mini-row"><span>Mount</span><span id="mini-m-pass">—</span><span id="mini-m-fail">—</span><span id="mini-m-total">—</span></div>
          <div class="mini-row"><span>Offload</span><span id="mini-o-pass">—</span><span id="mini-o-fail">—</span><span id="mini-o-total">—</span></div>
        </div>
      </div>

      <div class="score">
        <div class="score-label">Overall Pass Rate</div>
        <div class="score-val" id="scorePct">0%</div>
      </div>
    </div>
    <div class="right neo-card">
      <header>Event Log</header>
      <div class="tbl-wrap">
        <table class="hsl-table" id="hslTable">
          <thead>
            <tr>
              <th>GateOpsType</th>
              <th>Start</th>
              <th>End</th>
              <th>Haulier</th>
              <th>Service</th>
              <th>Type</th>
              <th>Location</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody><!-- filled by JS --></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script>
  /* ===== Glow plugin (keeps your neon vibe) ===== */
  var Glow = { id:'glow', afterDatasetsDraw:function(chart){
    var ctx = chart.ctx, data = chart.data;
    (data.datasets||[]).forEach(function(ds,i){
      if(ds.type && ds.type!=='line') return;
      var meta = chart.getDatasetMeta(i); if(!meta || !meta.dataset) return;
      ctx.save(); ctx.shadowColor=ds.borderColor||'#00F0FF'; ctx.shadowBlur=18; ctx.lineWidth=ds.borderWidth||2; meta.dataset.draw(ctx); ctx.restore();
    });
  }};

  /* ===== Standard line chart factory (for PPT1/2/3) ===== */
  function makeChart(id, series){
    var el = document.getElementById(id);
    if (!el) return null;

    var theme = getComputedStyle(document.documentElement);
    var COLORS = {
      mount: (theme.getPropertyValue('--accent') || '#00F0FF').trim(),
      off:   (theme.getPropertyValue('--accent-2') || '#B06CFF').trim(),
      avg:   '#ffd65a'
    };

    var hours = window.__hours || ['7:00','8:00','9:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00'];

    series = series || {};
    var sMount = Array.isArray(series.mounting) ? series.mounting : [];
    var sOff   = Array.isArray(series.offload)  ? series.offload  : [];
    var sAvg   = Array.isArray(series.avg)      ? series.avg      : [];

    return new Chart(el, {
      type: 'line',
      plugins: [Glow],
      data: {
        labels: hours,
        datasets: [
          { label: 'Mounting', data: sMount, borderColor: COLORS.mount, tension: 0.35, borderWidth: 2, pointRadius: 3, pointHoverRadius: 6 },
          { label: 'Offloading', data: sOff, borderColor: COLORS.off, tension: 0.35, borderWidth: 2, pointRadius: 3, pointHoverRadius: 6 },
          { label: 'Average Wait Time', data: sAvg, borderColor: COLORS.avg, borderDash: [6,6], tension: 0.35, borderWidth: 2, pointRadius: 0, pointHoverRadius: 0 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 900, easing: 'easeOutQuart' },
        interaction:{mode:'nearest', intersect:false},
        scales: {
          x: { grid: { color: 'rgba(255,255,255,.06)' } },
          y: { grid: { color: 'rgba(255,255,255,.06)' }, suggestedMin: 5, suggestedMax: 15, ticks: { stepSize: 1 } }
        },
        plugins: { legend: { display: false } }
      }
    });
  }

  /* ===== Animated line for Overview ===== */
  function makeOverviewAnimated(canvasId, hours, series){
    var el = document.getElementById(canvasId);
    if (!el) return null;

    var theme = getComputedStyle(document.documentElement);
    var COLORS = {
      mount: (theme.getPropertyValue('--accent') || '#00F0FF').trim(),
      off:   (theme.getPropertyValue('--accent-2') || '#B06CFF').trim(),
      avg:   '#ffd65a'
    };

    var labels = Array.isArray(hours) && hours.length ? hours
      : ['7:00','8:00','9:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00'];

    series = series || {};
    var sMount = Array.isArray(series.mounting) ? series.mounting : [];
    var sOff   = Array.isArray(series.offload)  ? series.offload  : [];
    var sAvg   = Array.isArray(series.avg)      ? series.avg      : [];

    var delayBetweenPoints = 120; // ms per point
    var animation = {
      x: {
        type: 'number',
        easing: 'linear',
        duration: delayBetweenPoints,
        from: NaN,
        delay: function(ctx){
          if (ctx.type !== 'data' || ctx.xStarted) return 0;
          ctx.xStarted = true;
          return ctx.dataIndex * delayBetweenPoints;
        }
      },
      y: {
        type: 'number',
        easing: 'linear',
        duration: delayBetweenPoints,
        from: function(ctx){
          var prev = ctx.chart.getDatasetMeta(ctx.datasetIndex).data[ctx.dataIndex - 1];
          return prev ? prev.getProps(['y'], true).y : NaN;
        },
        delay: function(ctx){
          if (ctx.type !== 'data' || ctx.yStarted) return 0;
          ctx.yStarted = true;
          return ctx.dataIndex * delayBetweenPoints;
        }
      }
    };

    var existing = Chart.getChart(el);
    if (existing){
      existing.options.animation = animation;
      existing.data.labels = labels;
      existing.data.datasets[0].data = sMount;
      existing.data.datasets[1].data = sOff;
      existing.data.datasets[2].data = sAvg;
      existing.update();
      return existing;
    }

    return new Chart(el, {
      type:'line',
      plugins:[Glow],
      data:{
        labels: labels,
        datasets:[
          { label:'Mounting', data: sMount, borderColor: COLORS.mount, tension:0.35, borderWidth:2, pointRadius:3, pointHoverRadius:6 },
          { label:'Offloading', data: sOff, borderColor: COLORS.off, tension:0.35, borderWidth:2, pointRadius:3, pointHoverRadius:6 },
          { label:'Average Wait Time', data: sAvg, borderColor: COLORS.avg, borderDash:[6,6], tension:0.35, borderWidth:2, pointRadius:0, pointHoverRadius:0 }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        animation: animation,             /* ← sweep animation */
        interaction:{mode:'nearest', intersect:false},
        scales:{
          x:{ grid:{ color:'rgba(255,255,255,.06)' } },
          y:{ grid:{ color:'rgba(255,255,255,.06)' }, suggestedMin:5, suggestedMax:15, ticks:{ stepSize:1 } }
        },
        plugins:{ legend:{ display:false } }
      }
    });
  }

  /* ===== Hydrator ===== */
  window.loadDeepDive = function(payload){
    if (!payload) return;
    if (payload.title){ var t=document.getElementById('pageTitle'); if(t) t.textContent=payload.title; }
    if (payload.meta){ var m=document.getElementById('pageMeta'); if(m) m.textContent=payload.meta; }
    window.__hours = payload.hours || window.__hours;

    /* Overview = animated line */
    var chOverview = makeOverviewAnimated('overview', window.__hours, payload.overview);

    /* PPT1/2/3 = standard line */
    var ch1 = makeChart('ppt1', payload.ppt1);
    var ch2 = makeChart('ppt2', payload.ppt2);
    var ch3 = makeChart('ppt3', payload.ppt3);

    /* ensure datasets are applied (idempotent updates) */
    [[chOverview,'overview'],[ch1,'ppt1'],[ch2,'ppt2'],[ch3,'ppt3']].forEach(function(pair){
      var ch = pair[0], key = pair[1];
      if(!ch || !payload[key]) return;
      ch.data.labels = window.__hours || ch.data.labels;
      var s = payload[key];
      ch.data.datasets[0].data = s.mounting||[];
      ch.data.datasets[1].data = s.offload||[];
      ch.data.datasets[2].data = s.avg||[];
      ch.update();
    });

    /* manning */
    if (payload.manning){
      var rows = payload.manning;
      function fillRows(id, rowsArr){
        var c=document.getElementById(id); if(!c) return; c.innerHTML='';
        (rowsArr||[]).forEach(function(p){
          var k=p[0], v=p[1];
          var r=document.createElement('div'); r.className='row';
          r.innerHTML='<span>'+k+'</span><span>'+v+'</span>';
          c.appendChild(r);
        });
      }
      fillRows('card-bc', rows.bc); fillRows('card-ppt2', rows.ppt2); fillRows('card-ppt3', rows.ppt3); fillRows('card-fm', rows.fm);
    }
  };

  /* Pills behavior & Deep Dive CTA (scroll) */
  (function(){
    var bar = document.getElementById('chipbar');
    var btn = document.getElementById('deepDiveBtn');
    btn.addEventListener('click', function(){
      var target = document.querySelector('.grid-3');
      if (target) window.scrollTo({top: target.offsetTop - 12, behavior: 'smooth'});
    });
    bar.addEventListener('click', function(e){
      var b = e.target.closest('.pill'); if(!b) return;
      Array.prototype.forEach.call(bar.querySelectorAll('.pill'), function(x){
        x.classList.remove('active'); x.setAttribute('aria-selected','false');
      });
      b.classList.add('active'); b.setAttribute('aria-selected','true');
      // Optional: reload with selected
      // location.href = "{{ url_for('daily.index') }}?date=" + encodeURIComponent(b.dataset.date) + "&shift=" + encodeURIComponent(b.dataset.shift);
    });
  })();
  </script>

  <!-- Fallback dummy payload (used if server doesn't provide one) -->
  <script>
    var __FALLBACK_PAYLOAD__ = (function(){
      var hours = ['7:00','8:00','9:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00'];
      function S(a){ return a.slice(); }
      var overview = {
        mounting: S([12.8,10.2, 9.9,11.5,12.3,11.8, 9.6, 8.7,12.8,11.6,10.3, 7.9,12.5]),
        offload:  S([12.8,11.3,14.5,12.8,12.3,11.5, 8.6, 9.7,12.8,11.4,10.3, 6.5,12.8]),
        avg:      S([11.2,10.1,10.3,11.0,11.8,10.8, 9.3, 9.9,11.2,10.7,10.6, 8.4,12.0])
      };
      function pack(m,o,a){ return { mounting:S(m), offload:S(o), avg:S(a) }; }

      var ttl = (document.getElementById('pageTitle') && document.getElementById('pageTitle').textContent) || '01 Jan 25 D';
      var meta = (document.getElementById('pageMeta') && document.getElementById('pageMeta').textContent) || 'Daily · P123';

      return {
        title: ttl,
        meta:  meta,
        hours: hours,
        overview: overview,
        ppt1: pack([11,9,12,8,10,14,13,12,9,8,7,5,6],
                   [ 9,10,8,12,11,10,13,12,12,9,8,7,10],
                   [10,9.5,10,9.8,10.5,10.6,9.9,10.1,10.3,9.9,9.8,9.7,10.2]),
        ppt2: pack([13,12,9,9,8,9,10,11,10,10,11,13,14],
                   [12, 9,8,10,10,9,10,11,12,11,12,12,10],
                   [ 9.5,9.2,9.0,9.3,9.6,9.8,9.7,9.9,10.3,10.2,10.1,10.0,10.4]),
        ppt3: pack([12,15,13,12,11,10,9,11,12,13,14,15,13],
                   [10,11, 9, 8, 9,10,12,13,10,12,11,12,12],
                   [ 9.8,9.9,10.2,10.5,10.1, 9.7,9.5,10.0,10.4,10.7,10.9,11.2,10.8]),
        manning:{
          bc:   [["Adjusted Deployment","11"],["Available Manpower","11"],["Max Deployable Fleet","12"],["Previous Forecast","11"],["Today Demand","13"]],
          ppt2: [["Adjusted Deployment","48/47+1 SAMSUNG | 11"],["Available Manpower","64/63+1 SAMSUNG"],["Max Deployable Fleet","49 | 11"],["Previous Forecast","51 | 13"],["Today Demand","51 | 13"]],
          ppt3: [["Adjusted Deployment","58/57+1 DOOSAN"],["Available Manpower","55/54+1 DOOSAN"],["Max Deployable Fleet","58"],["Previous Forecast","57"],["Today Demand","57"]],
          fm:   [["Adjusted Deployment","15+4 EDO"],["Available Manpower","19"],["Max Deployable Fleet","21 +1 TLOAN"],["Previous Forecast","24"],["Today Demand","19"]]
        }
      };
    })();
  </script>

  <!-- Server payload (rendered by Flask). Safe even if empty. -->
  <script id="server-payload" type="application/json">
    {{ payload | tojson }}
  </script>

  <!-- Hydrate with server payload or fallback -->
  <script>
    (function () {
      var serverPayload = null;
      var el = document.getElementById('server-payload');
      if (el) {
        var txt = (el.textContent || '').trim();
        if (txt) {
          try { serverPayload = JSON.parse(txt); } catch (_) { serverPayload = null; }
        }
      }
      var initialPayload = serverPayload || __FALLBACK_PAYLOAD__;
      window.addEventListener('DOMContentLoaded', function () {
        if (initialPayload && typeof window.loadDeepDive === 'function') {
          window.loadDeepDive(initialPayload);
        }
      });
    })();
  </script>
  <script>
/* ---------- Dummy HSL data ---------- */
var HSL_DUMMY = {
  PPT1: {
    mount: { pass:105, fail:42 },
    off:   { pass: 26, fail:33 },
    rows: [
      {type:'Mounting', start:'06:27', end:'07:37', haulier:'THONG LEE', svc:70, ctype:'GP',  loc:'F13-37-37-14-02', result:'Pass'},
      {type:'Mounting', start:'06:27', end:'07:48', haulier:'CA TPT',   svc:81, ctype:'GP',  loc:'F13-37-37-03-02', result:'Pass'},
      {type:'Mounting', start:'06:53', end:'07:55', haulier:'LEGEND',   svc:62, ctype:'GP',  loc:'F13-38-38-12-03', result:'Pass'},
      {type:'Mounting', start:'06:54', end:'07:41', haulier:'PTC',      svc:47, ctype:'TK',  loc:'A13-24-24-11-01', result:'Fail'},
      {type:'Mounting', start:'07:01', end:'08:09', haulier:'LCH LOGIS',svc:53, ctype:'GP',  loc:'F13-37-37-05-03', result:'Pass'},
      {type:'Offload',  start:'08:35', end:'09:02', haulier:'OCWS',     svc:38, ctype:'RF',  loc:'D13-38-38-02-07', result:'Fail'},
      {type:'Offload',  start:'09:20', end:'10:10', haulier:'WYN 2000', svc:37, ctype:'RF',  loc:'A13-35-36-12-01', result:'Pass'},
      {type:'Offload',  start:'10:18', end:'11:02', haulier:'PALTRANS', svc:49, ctype:'GP',  loc:'D13-39-40-05-01', result:'Pass'}
    ]
  },
  PPT2: {
    mount: { pass:96, fail:31 },
    off:   { pass:40, fail:22 },
    rows: []
  },
  PPT3: {
    mount: { pass:112, fail:29 },
    off:   { pass:35, fail:28 },
    rows: []
  }
};

/* ---------- Center text plugin for donuts ---------- */
var CenterText = {
  id:'centerText',
  afterDatasetsDraw: function(chart, args, opts){
    var ctx = chart.ctx;
    var v = opts && opts.text ? String(opts.text) : '';
    if (!v) return;
    ctx.save();
    ctx.font = '800 22px Montserrat, Arial, sans-serif';
    ctx.fillStyle = '#EAF4FF';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    var x = chart.getDatasetMeta(0).data[0].x;
    var y = chart.getDatasetMeta(0).data[0].y;
    ctx.fillText(v, x, y);
    ctx.restore();
  }
};

/* ---------- Build/update a donut ---------- */
function makeDonut(id, passCount, failCount, pctText){
  var el = document.getElementById(id);
  if(!el) return null;
  var existing = Chart.getChart(el);
  var data = {
    labels:['Pass','Fail'],
    datasets:[{
      data:[passCount, failCount],
      backgroundColor:[ '#43FF93', '#FF647C' ],
      hoverOffset: 4,
      borderWidth: 0
    }]
  };
  var common = {
    type:'doughnut',
    data:data,
    plugins:[CenterText],
    options:{
      cutout:'62%',
      animation:{ animateRotate:true, animateScale:true, duration:900, easing:'easeOutQuart' },
      plugins:{ legend:{ display:false }, centerText:{ text:pctText } }
    }
  };
  if (existing){ existing.options.plugins.centerText.text = pctText; existing.data = data; existing.update(); return existing; }
  return new Chart(el, common);
}

/* ---------- Fill the mini table and right table ---------- */
function fillMiniAndTable(key){
  var d = HSL_DUMMY[key] || HSL_DUMMY.PPT1;
  // mini
  var mT = d.mount.pass + d.mount.fail, oT = d.off.pass + d.off.fail;
  document.getElementById('mini-m-pass').textContent = d.mount.pass;
  document.getElementById('mini-m-fail').textContent = d.mount.fail;
  document.getElementById('mini-m-total').textContent = mT;
  document.getElementById('mini-o-pass').textContent = d.off.pass;
  document.getElementById('mini-o-fail').textContent = d.off.fail;
  document.getElementById('mini-o-total').textContent = oT;

  // score
  var pct = Math.round(((d.mount.pass + d.off.pass) / (mT + oT)) * 1000)/10; // one decimal
  document.getElementById('scorePct').textContent = pct.toFixed(1) + '%';

  // donuts
  makeDonut('donutMount', d.mount.pass, d.mount.fail, Math.round((d.mount.pass/mT)*100)+'%');
  makeDonut('donutOff',   d.off.pass,   d.off.fail,   Math.round((d.off.pass/oT)*100)+'%');

  // table
  var tb = document.querySelector('#hslTable tbody');
  tb.innerHTML = '';
  (d.rows.length ? d.rows : HSL_DUMMY.PPT1.rows).forEach(function(r){
    var tr = document.createElement('tr');
    tr.innerHTML =
      '<td>'+r.type+'</td>'+
      '<td>'+r.start+'</td>'+
      '<td>'+r.end+'</td>'+
      '<td>'+r.haulier+'</td>'+
      '<td>'+r.svc+'</td>'+
      '<td>'+r.ctype+'</td>'+
      '<td>'+r.loc+'</td>'+
      '<td><span class="badge '+(r.result==='Pass'?'pass':'fail')+'">'+r.result+'</span></td>';
    tb.appendChild(tr);
  });
}

/* ---------- Segmented control ---------- */
(function(){
  var seg = document.getElementById('hslSeg');
  seg.addEventListener('click', function(e){
    var b = e.target.closest('.seg-btn'); if(!b) return;
    Array.prototype.forEach.call(seg.children, function(x){ x.classList.remove('active'); });
    b.classList.add('active');
    fillMiniAndTable(b.dataset.key);
  });

  // initial
  fillMiniAndTable('PPT1');
})();
</script>

</body>
</html>
