<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Data Entry</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 2em auto; }
        label { display: block; margin-top: 1em; }
        select, input[type="text"], input[type="date"] { width: 100%; padding: 0.4em; margin-top: 0.3em; }
        button { margin-top: 1.5em; padding: 0.6em 1.2em; }
        .message { margin-top: 1em; padding: 0.7em; border-radius: 5px; }
        .error { background-color: #fdd; border: 1px solid #f99; color: #900; }
        .success { background-color: #dfd; border: 1px solid #9f9; color: #060; }
    </style>
</head>
<body>
    <nav style="background:#eee; padding:0.5em 1em; margin-bottom:1em;">
        <a href="{{ url_for('index') }}">Home</a> |
        <a href="{{ url_for('entry_form') }}">Entry</a>
    </nav>
    <h2>Enter YWT Data</h2>

    {% if message %}
        <div class="message error">{{ message }}</div>
    {% endif %}
    {% if success %}
        <div class="message success">âœ… Data saved successfully!</div>
    {% endif %}

    <form method="POST">
        <label for="date">Date:</label>
        <input
            type="date"
            id="date"
            name="date"
            value="{{ selected_date or '' }}"
            required
            max="{{ max_date }}"
            min="{{ min_date or '2000-01-01' }}"
        />

        <label for="shift">Shift:</label>
        <select id="shift" name="shift" required>
            <option value="">-- Select Shift --</option>
            <option value="D" {% if selected_shift == 'D' %}selected{% endif %}>D</option>
            <option value="N" {% if selected_shift == 'N' %}selected{% endif %}>N</option>
        </select>

        <label for="time">Time:</label>
        <select id="time" name="time" required>
            <!-- Time options will be inserted here by JavaScript -->
        </select>

        <label for="ywt">YWT:</label>
        <input
            type="text"
            id="ywt"
            name="ywt"
            placeholder="Enter YWT value"
            value="{{ ywt or '' }}"
            required
        />

        <button type="submit">Submit</button>
    </form>

    <!-- Hidden JSON data block -->
    <script id="shift-data" type="application/json">
    {
      "day": {{ day_shift_times | tojson | safe }},
      "night": {{ night_shift_times | tojson | safe }}
    }
    </script>

    <!-- JS for handling shift/time logic -->
    <script>
    const shiftData = JSON.parse(document.getElementById("shift-data").textContent);
    const dayTimes = shiftData.day;
    const nightTimes = shiftData.night;

    const shiftSelect = document.getElementById('shift');
    const timeSelect = document.getElementById('time');
    const selectedTime = "{{ selected_time or '' }}";

    function populateTimes(times, selectNext = false) {
        timeSelect.innerHTML = '';
        times.forEach(t => {
            const option = document.createElement('option');
            option.value = t;
            option.textContent = t;
            timeSelect.appendChild(option);
        });

        // Set selected time or move to next one
        const urlParams = new URLSearchParams(window.location.search);
        const isSuccess = urlParams.get("success");

        if (isSuccess === "1" && selectedTime) {
            const idx = times.indexOf(selectedTime);
            if (idx !== -1 && idx < times.length - 1) {
                timeSelect.value = times[idx + 1];  // move to next
            } else {
                timeSelect.value = "";  // no more
            }
        } else if (selectedTime) {
            timeSelect.value = selectedTime;
        }
    }

    shiftSelect.addEventListener('change', () => {
        if (shiftSelect.value === 'D') {
            populateTimes(dayTimes);
        } else if (shiftSelect.value === 'N') {
            populateTimes(nightTimes);
        } else {
            timeSelect.innerHTML = '';
        }
    });

    // Initialize on load
    window.onload = () => {
    if (shiftSelect.value === 'D') {
        populateTimes(dayTimes);
    } else if (shiftSelect.value === 'N') {
        populateTimes(nightTimes);
    }

    // Set the time value (after populate)
    if ("{{ selected_time }}" !== "") {
        timeSelect.value = "{{ selected_time }}";
    }
    };
</script>
</body>
</html>
